<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - English Dictation</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/teacher.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">
                        ğŸ“ English Dictation
                    </h1>
                    <span class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">êµì‚¬</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="teacherName">-</span>
                    <button 
                        onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm"
                    >
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ëŒ€ì‹œë³´ë“œ í—¤ë” -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-gray-900">ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="text-gray-600 mt-1">í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í•˜ê³  í•™ìƒë“¤ì˜ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
                </div>
                <button 
                    onclick="createNewTest()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold flex items-center space-x-2"
                >
                    <span>â•</span>
                    <span>ìƒˆ í…ŒìŠ¤íŠ¸ ìƒì„±</span>
                </button>
            </div>
        </div>        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <span class="text-2xl">ğŸ“</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">ì´ í…ŒìŠ¤íŠ¸</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalTests">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <span class="text-2xl">âœ…</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">í™œì„± í…ŒìŠ¤íŠ¸</p>
                        <p class="text-2xl font-bold text-gray-900" id="activeTests">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ëª©ë¡ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">í…ŒìŠ¤íŠ¸ ëª©ë¡</h3>
                    <div class="flex space-x-2">
                        <select id="filterStatus" class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                            <option value="all">ì „ì²´</option>
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                        </select>
                        <button onclick="refreshTests()" class="text-gray-400 hover:text-gray-600">
                            ğŸ”„
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                í…ŒìŠ¤íŠ¸ ì •ë³´
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ì½”ë“œ
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ìƒíƒœ
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ì°¸ì—¬ì
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ìƒì„±ì¼
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ì‘ì—…
                            </th>
                        </tr>
                    </thead>
                    <tbody id="testsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- í…ŒìŠ¤íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
            
            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="emptyState" class="hidden text-center py-12">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <span class="text-4xl text-gray-400">ğŸ“</span>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ì•„ì§ ìƒì„±ëœ í…ŒìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p class="text-gray-500 mb-6">ì²« ë²ˆì§¸ ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”!</p>
                <button 
                    onclick="createNewTest()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                    í…ŒìŠ¤íŠ¸ ìƒì„±í•˜ê¸°
                </button>
            </div>
        </div>
    </main>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span>ë¡œë”© ì¤‘...</span>
        </div>
    </div>    <!-- JavaScript -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/test-code.js"></script>
    <script src="../js/teacher.js"></script>
    
    <script>
        let currentUser = null;
        let userTests = [];

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        async function initializeDashboard() {
            // ì¸ì¦ ìƒíƒœ í™•ì¸
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserInfo();
                    await loadTests();
                    updateStatistics();
                } else {
                    window.location.href = '../index.html';
                }
            });

            // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('filterStatus').addEventListener('change', filterTests);
        }        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                console.log('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œì‘:', currentUser.uid, currentUser.displayName);
                
                // ì‚¬ìš©ì ë¬¸ì„œ í™•ì¸ ë° ìƒì„± (ensureUserDocument í˜¸ì¶œ)
                await ensureUserDocument(currentUser.uid, currentUser.email, currentUser.displayName || 'ì„ ìƒë‹˜');
                
                // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ë¬¸ì„œ ë‹¤ì‹œ ë¡œë“œ
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const displayName = userData.displayName || currentUser.displayName || currentUser.email || 'ì„ ìƒë‹˜';
                    document.getElementById('teacherName').textContent = displayName;
                    console.log('ì‚¬ìš©ì displayName ì„¤ì • ì™„ë£Œ:', displayName);
                } else {
                    console.warn('ì‚¬ìš©ì ë¬¸ì„œê°€ ì—¬ì „íˆ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                    document.getElementById('teacherName').textContent = currentUser.displayName || currentUser.email || 'ì„ ìƒë‹˜';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ê°’ ì„¤ì •
                document.getElementById('teacherName').textContent = currentUser.displayName || currentUser.email || 'ì„ ìƒë‹˜';
            }
        }

        // í…ŒìŠ¤íŠ¸ ëª©ë¡ ë¡œë“œ
        async function loadTests() {
            showLoading();
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    userTests = [];
                    renderTests();
                    return;
                }

                const userData = userDoc.data();
                const testCodes = userData.testCodes || [];

                if (testCodes.length === 0) {
                    userTests = [];
                    renderTests();
                    return;
                }

                // ê° í…ŒìŠ¤íŠ¸ ì½”ë“œì— ëŒ€í•œ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const testPromises = testCodes.map(async (code) => {
                    const testDoc = await db.collection('tests').doc(code).get();
                    if (testDoc.exists) {
                        return { id: code, ...testDoc.data() };
                    }
                    return null;
                });

                const tests = await Promise.all(testPromises);
                userTests = tests.filter(test => test !== null);
                
                renderTests();
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                showToast('í…ŒìŠ¤íŠ¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // í…ŒìŠ¤íŠ¸ ëª©ë¡ ë Œë”ë§
        function renderTests() {
            const tbody = document.getElementById('testsTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (userTests.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            const html = userTests.map(test => {
                const participantCount = Object.keys(test.participants || {}).length;
                const statusBadge = test.isActive 
                    ? '<span class="badge badge-success">í™œì„±</span>'
                    : '<span class="badge badge-error">ë¹„í™œì„±</span>';
                
                const createdDate = test.createdAt 
                    ? new Date(test.createdAt.toDate()).toLocaleDateString()
                    : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${test.title}</div>
                                <div class="text-sm text-gray-500">${test.sentences?.length || 0}ê°œ ë¬¸ì¥</div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-mono font-bold text-blue-600">${test.testCode}</span>
                                <button onclick="copyTestCode('${test.testCode}')" class="text-gray-400 hover:text-blue-600" title="ì½”ë“œ ë³µì‚¬">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${participantCount}ëª…</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">${createdDate}</div>
                        </td>                        <td class="px-6 py-4">
                            <div class="flex space-x-2">
                                <button onclick="monitorTest('${test.testCode}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                    ëª¨ë‹ˆí„°ë§
                                </button>
                                <button onclick="editTest('${test.testCode}')" class="text-green-600 hover:text-green-800 text-sm">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="toggleTestStatus('${test.testCode}', ${test.isActive})" class="text-yellow-600 hover:text-yellow-800 text-sm">
                                    ${test.isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}
                                </button>
                                <button onclick="deleteTest('${test.testCode}', '${test.title}')" class="text-red-600 hover:text-red-800 text-sm">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const totalTests = userTests.length;
            const activeTests = userTests.filter(test => test.isActive).length;

            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('activeTests').textContent = activeTests;
        }

        // í…ŒìŠ¤íŠ¸ í•„í„°ë§
        function filterTests() {
            const filter = document.getElementById('filterStatus').value;
            let filteredTests = userTests;

            if (filter === 'active') {
                filteredTests = userTests.filter(test => test.isActive);
            } else if (filter === 'inactive') {
                filteredTests = userTests.filter(test => !test.isActive);
            }

            // ì„ì‹œë¡œ userTestsë¥¼ ë³€ê²½í•˜ì—¬ ë Œë”ë§
            const originalTests = [...userTests];
            userTests = filteredTests;
            renderTests();
            userTests = originalTests;
        }

        // ìƒˆ í…ŒìŠ¤íŠ¸ ìƒì„±
        function createNewTest() {
            window.location.href = 'create-test.html';
        }        // í…ŒìŠ¤íŠ¸ ëª¨ë‹ˆí„°ë§
        function monitorTest(testCode) {
            console.log('ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ë¡œ ì´ë™:', testCode);
            
            // í˜„ì¬ ì¸ì¦ ìƒíƒœë¥¼ localStorageì— ì €ì¥
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                localStorage.setItem('authState', JSON.stringify({
                    authenticated: true,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    timestamp: Date.now()
                }));
                console.log('ì¸ì¦ ìƒíƒœ localStorageì— ì €ì¥');
            }
            
            // ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `monitor.html?code=${testCode}`;
        }

        // í…ŒìŠ¤íŠ¸ ìˆ˜ì •
        function editTest(testCode) {
            window.location.href = `edit-test.html?code=${testCode}`;
        }        // í…ŒìŠ¤íŠ¸ ìƒíƒœ í† ê¸€
        async function toggleTestStatus(testCode, currentStatus) {
            if (!confirm(`í…ŒìŠ¤íŠ¸ë¥¼ ${currentStatus ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            showLoading();
            try {
                await db.collection('tests').doc(testCode).update({
                    isActive: !currentStatus
                });

                showToast(`í…ŒìŠ¤íŠ¸ê°€ ${!currentStatus ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                await loadTests();
                updateStatistics();
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                showToast('í…ŒìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }        // í…ŒìŠ¤íŠ¸ ì‚­ì œ
        async function deleteTest(testCode, testTitle) {
            // ì´ì¤‘ í™•ì¸
            if (!confirm(`ì •ë§ë¡œ í…ŒìŠ¤íŠ¸ "${testTitle}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ë‹¤ìŒ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\n- í…ŒìŠ¤íŠ¸ ì •ë³´\n- ì°¸ì—¬ì ë°ì´í„°\n- ë‹µì•ˆ ê¸°ë¡\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ìµœì¢… í™•ì¸
            if (!confirm(`ìµœì¢… í™•ì¸: "${testTitle}" í…ŒìŠ¤íŠ¸ë¥¼ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.`)) {
                return;
            }

            showLoading();
            try {
                // Firestoreì—ì„œ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì‚­ì œ
                await db.collection('tests').doc(testCode).delete();

                // í˜„ì¬ ì‚¬ìš©ìì˜ testCodes ë°°ì—´ì—ì„œ í•´ë‹¹ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œê±°
                if (currentUser) {
                    const userRef = db.collection('users').doc(currentUser.uid);
                    await userRef.update({
                        testCodes: firebase.firestore.FieldValue.arrayRemove(testCode)
                    });
                }

                showToast(`í…ŒìŠ¤íŠ¸ "${testTitle}"ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // í…ŒìŠ¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadTests();
                updateStatistics();
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
                showToast('í…ŒìŠ¤íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                hideLoading();
            }
        }

        // í…ŒìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        async function refreshTests() {
            await loadTests();
            updateStatistics();
            showToast('í…ŒìŠ¤íŠ¸ ëª©ë¡ì´ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // í…ŒìŠ¤íŠ¸ ì½”ë“œ ë³µì‚¬
        function copyTestCode(testCode) {
            navigator.clipboard.writeText(testCode).then(() => {
                showToast(`í…ŒìŠ¤íŠ¸ ì½”ë“œ ${testCode}ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            }).catch(() => {
                // í´ë°±: í…ìŠ¤íŠ¸ ì„ íƒ
                showToast(`í…ŒìŠ¤íŠ¸ ì½”ë“œ: ${testCode}`, 'info');
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('loadingSpinner').classList.remove('flex');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/teacher.js"></script>
</body>
</html>
