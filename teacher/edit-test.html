<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 수정 - English Dictation</title>
      <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- SortableJS for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/teacher.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 로딩 스피너 -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span>테스트 정보를 불러오는 중...</span>
        </div>
    </div>

    <!-- 헤더 -->
    <header class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="text-gray-600 hover:text-gray-800">
                        ← 돌아가기
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">테스트 수정</h1>
                        <p class="text-sm text-gray-500">테스트 코드: <span id="headerTestCode" class="font-mono font-semibold text-blue-600"></span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="teacherName">-</span>
                    <button 
                        onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm"
                    >
                        로그아웃
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form id="editTestForm" class="space-y-8">
            <!-- 기본 정보 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">기본 정보</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="form-label">테스트 제목 <span class="text-red-500">*</span></label>
                        <input 
                            type="text" 
                            id="testTitle"
                            class="form-input"
                            placeholder="예: 중간고사 영어 받아쓰기"
                            required
                        >
                    </div>
                    
                    <div>
                        <label class="form-label">설명 (선택사항)</label>
                        <textarea 
                            id="testDescription"
                            class="form-input form-textarea"
                            placeholder="테스트에 대한 간단한 설명을 입력하세요"
                        ></textarea>
                    </div>
                </div>
            </div>

            <!-- 테스트 설정 -->
            <div class="settings-panel">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">테스트 설정</h2>
                
                <div class="settings-grid">
                    <div>
                        <label class="form-label">시간 제한</label>
                        <select id="timeLimit" class="form-input">
                            <option value="">제한 없음</option>
                            <option value="300">5분</option>
                            <option value="600">10분</option>
                            <option value="900">15분</option>
                            <option value="1200">20분</option>
                            <option value="1800">30분</option>
                            <option value="custom">직접 입력</option>
                        </select>
                        <input 
                            type="number" 
                            id="customTimeLimit"
                            class="form-input mt-2 hidden"
                            placeholder="분 단위로 입력"
                            min="1"
                            max="180"
                        >
                    </div>
                    
                    <div>
                        <label class="form-label">재시도 허용</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="allowRetry" class="custom-checkbox">
                            <span class="text-sm text-gray-600">학생이 테스트를 다시 볼 수 있도록 허용</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">결과 즉시 공개</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="showResultsImmediately" class="custom-checkbox" checked>
                            <span class="text-sm text-gray-600">테스트 완료 후 즉시 결과 표시</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">음성 속도</label>
                        <select id="speechRate" class="form-input">
                            <option value="0.8">느림 (0.8x)</option>
                            <option value="1.0" selected>보통 (1.0x)</option>
                            <option value="1.2">빠름 (1.2x)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 채점 옵션 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">채점 옵션</h2>
                
                <div class="settings-grid">
                    <div>
                        <label class="form-label">대소문자 구분</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="caseSensitive" class="custom-checkbox">
                            <span class="text-sm text-gray-600">대소문자를 구분하여 채점</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">구두점 체크</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="checkPunctuation" class="custom-checkbox" checked>
                            <span class="text-sm text-gray-600">마침표, 쉼표 등 구두점 확인</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">여백 무시</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="ignoreSpaces" class="custom-checkbox">
                            <span class="text-sm text-gray-600">단어 사이 여백 개수 무시</span>
                        </div>
                    </div>
                      <div>
                        <label class="form-label">부분 점수</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="partialCredit" class="custom-checkbox" checked>
                            <span class="text-sm text-gray-600">단어별 부분 점수 부여</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 문장 관리 섹션 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900">문장 관리</h2>
                    <div class="flex space-x-2">
                        <button type="button" id="bulkAddBtn" class="btn-secondary">
                            <i class="fas fa-file-import mr-2"></i>대량 추가
                        </button>
                        <button type="button" id="addSentenceBtn" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>문장 추가
                        </button>
                    </div>
                </div>

                <!-- 문장 카운트 및 안내 -->
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-medium">총 <span id="sentenceCount">0</span>개 문장</span>
                        • 드래그하여 순서 변경 가능
                    </p>
                </div>

                <!-- 문장 목록 -->
                <div id="sentencesList" class="space-y-4">
                    <!-- 문장들이 여기에 동적으로 추가됩니다 -->
                </div>

                <!-- 빈 상태 -->
                <div id="emptySentencesState" class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
                    <div class="text-4xl text-gray-400 mb-4">📝</div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">아직 추가된 문장이 없습니다</h3>
                    <p class="text-gray-500 mb-4">첫 번째 문장을 추가해보세요!</p>
                    <button 
                        type="button"
                        onclick="addSentence()"
                        class="btn-primary"
                    >
                        문장 추가하기
                    </button>
                </div>
            </div>

            <!-- 미리보기 -->
            <div class="bg-blue-50 rounded-xl border border-blue-200 p-6 mt-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">미리보기</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-medium text-gray-900 mb-2">테스트 정보</h3>
                        <div class="bg-white rounded-lg p-4 text-sm">
                            <p><strong>제목:</strong> <span id="previewTitle">-</span></p>
                            <p><strong>문장 수:</strong> <span id="previewSentenceCount">0</span>개</p>
                            <p><strong>시간 제한:</strong> <span id="previewTimeLimit">제한 없음</span></p>
                            <p><strong>재시도:</strong> <span id="previewAllowRetry">불허용</span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-900 mb-2">테스트 코드</h3>
                        <div class="bg-white rounded-lg p-4 text-center">
                            <p class="text-sm text-gray-600 mb-2">현재 테스트 코드</p>
                            <p class="text-2xl font-mono font-bold text-blue-600" id="previewTestCode">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 제출 버튼 -->
            <div class="flex justify-end space-x-4 mt-8">
                <button 
                    type="button"
                    onclick="goBack()"
                    class="px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors"
                >
                    취소
                </button>
                <button 
                    type="submit"
                    class="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                >
                    테스트 수정 완료
                </button>
            </div>
        </form>
    </main>

    <!-- 문장 가져오기 모달 -->
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">문장 가져오기</h3>
            <div class="space-y-4">
                <div>
                    <label class="form-label">텍스트 파일 선택</label>
                    <input 
                        type="file" 
                        id="sentenceFile"
                        accept=".txt"
                        class="form-input"
                    >
                    <p class="text-xs text-gray-500 mt-1">
                        .txt 파일, 한 줄에 하나씩 문장 작성
                    </p>
                </div>
                <div>
                    <label class="form-label">또는 직접 입력</label>
                    <textarea 
                        id="bulkSentences"
                        class="form-input form-textarea"
                        placeholder="한 줄에 하나씩 문장을 입력하세요&#10;예:&#10;Hello, how are you?&#10;I am fine, thank you."
                    ></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeImportModal()" class="btn-secondary">취소</button>
                <button onclick="processSentenceImport()" class="btn-primary">가져오기</button>
            </div>
        </div>
    </div>

    <!-- 수정 완료 모달 -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <span class="text-3xl">✅</span>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">테스트 수정 완료!</h3>
                <p class="text-gray-600 mb-6">테스트가 성공적으로 수정되었습니다.</p>
                
                <div class="bg-blue-50 rounded-lg p-6 mb-6">
                    <p class="text-sm text-gray-600 mb-2">테스트 제목</p>
                    <p class="font-semibold text-gray-900 mb-4" id="modalTestTitle">-</p>
                    
                    <p class="text-sm text-gray-600 mb-2">테스트 코드</p>
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-3xl font-mono font-bold text-blue-600" id="modalTestCode">ABC123</span>
                        <button onclick="copyTestCode()" class="text-blue-600 hover:text-blue-800" title="코드 복사">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">학생들이 이 코드로 테스트에 참여할 수 있습니다</p>
                </div>
                
                <div class="space-y-3">
                    <button onclick="goToMonitoring()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        실시간 모니터링으로 이동
                    </button>
                    <button onclick="goToDashboard()" class="w-full bg-gray-200 text-gray-800 py-3 px-4 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        대시보드로 돌아가기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/test-code.js"></script>
    <script src="../js/teacher.js"></script>
    
    <script>
        let currentUser = null;
        let sentences = [];
        let sentenceCounter = 0;
        let sortableInstance = null;
        let currentTestCode = null;
        let isEditMode = true;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditTest();
        });

        // 수정 페이지 초기화
        function initializeEditTest() {
            // URL에서 테스트 코드 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            currentTestCode = urlParams.get('code');
            
            if (!currentTestCode) {
                alert('테스트 코드가 없습니다.');
                window.location.href = 'dashboard.html';
                return;
            }

            // 헤더에 테스트 코드 표시
            document.getElementById('headerTestCode').textContent = currentTestCode;
            document.getElementById('previewTestCode').textContent = currentTestCode;

            // 인증 상태 확인
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserInfo();
                    await loadTestData();
                    setupEventListeners();
                    hideLoadingSpinner();
                } else {
                    window.location.href = '../index.html';
                }
            });
        }        // 사용자 정보 로드
        async function loadUserInfo() {
            try {
                console.log('사용자 정보 로드 시작:', currentUser.uid, currentUser.displayName);
                
                // 사용자 문서 확인 및 생성 (ensureUserDocument 호출)
                await ensureUserDocument(currentUser.uid, currentUser.email, currentUser.displayName || '선생님');
                
                // 업데이트된 사용자 문서 다시 로드
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const displayName = userData.displayName || currentUser.displayName || currentUser.email || '선생님';
                    document.getElementById('teacherName').textContent = displayName;
                    console.log('사용자 displayName 설정 완료:', displayName);
                } else {
                    console.warn('사용자 문서가 여전히 존재하지 않음');
                    document.getElementById('teacherName').textContent = currentUser.displayName || currentUser.email || '선생님';
                }
            } catch (error) {
                console.error('사용자 정보 로드 오류:', error);
                // 오류가 발생해도 기본값 설정
                document.getElementById('teacherName').textContent = currentUser.displayName || currentUser.email || '선생님';
            }
        }

        // 테스트 데이터 로드
        async function loadTestData() {
            try {
                console.log('테스트 데이터 로드 시작:', currentTestCode);
                
                const testDoc = await db.collection('tests').doc(currentTestCode).get();
                
                if (!testDoc.exists) {
                    console.error('테스트 문서가 존재하지 않습니다');
                    alert('테스트를 찾을 수 없습니다.');
                    window.location.href = 'dashboard.html';
                    return;
                }

                const testData = testDoc.data();
                console.log('로드된 테스트 데이터:', testData);

                // 기본 정보 채우기
                document.getElementById('testTitle').value = testData.title || '';
                document.getElementById('testDescription').value = testData.description || '';

                // 설정 정보 채우기
                if (testData.settings) {
                    const settings = testData.settings;
                    
                    // 시간 제한
                    if (settings.timeLimit) {
                        const predefined = ['300', '600', '900', '1200', '1800'];
                        if (predefined.includes(String(settings.timeLimit))) {
                            document.getElementById('timeLimit').value = settings.timeLimit;
                        } else {
                            document.getElementById('timeLimit').value = 'custom';
                            document.getElementById('customTimeLimit').value = Math.floor(settings.timeLimit / 60);
                            document.getElementById('customTimeLimit').classList.remove('hidden');
                        }
                    }

                    document.getElementById('allowRetry').checked = settings.allowRetry || false;
                    document.getElementById('showResultsImmediately').checked = settings.showResultsImmediately !== false;
                    document.getElementById('speechRate').value = settings.speechRate || '1.0';

                    // 채점 옵션
                    if (settings.scoring) {
                        document.getElementById('caseSensitive').checked = settings.scoring.caseSensitive || false;
                        document.getElementById('checkPunctuation').checked = settings.scoring.checkPunctuation !== false;
                        document.getElementById('ignoreSpaces').checked = settings.scoring.ignoreSpaces || false;
                        document.getElementById('partialCredit').checked = settings.scoring.partialCredit !== false;
                    }
                }

                // 문장 정보 로드
                if (testData.sentences && Array.isArray(testData.sentences)) {
                    sentences = testData.sentences.map((sentence, index) => ({
                        ...sentence,
                        id: sentence.id || `sentence_${index + 1}`,
                        order: sentence.order || index + 1
                    }));
                    sentenceCounter = sentences.length;
                    renderSentences();
                }

                updatePreview();
                
            } catch (error) {
                console.error('테스트 데이터 로드 오류:', error);
                alert('테스트 데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 로딩 스피너 숨기기
        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 폼 제출 (수정 모드)
            document.getElementById('editTestForm').addEventListener('submit', handleFormSubmit);

            // 실시간 미리보기 업데이트
            document.getElementById('testTitle').addEventListener('input', updatePreview);
            document.getElementById('timeLimit').addEventListener('change', handleTimeLimitChange);
            document.getElementById('customTimeLimit').addEventListener('input', updatePreview);
            document.getElementById('allowRetry').addEventListener('change', updatePreview);
            document.getElementById('showResultsImmediately').addEventListener('change', updatePreview);

            // 문장 관리 버튼들
            document.getElementById('addSentenceBtn').addEventListener('click', function() {
                addSentence();
            });            document.getElementById('bulkAddBtn').addEventListener('click', function() {
                importSentences();
            });

            // Sortable 초기화
            initializeSortable();
        }

        // 폼 제출 처리 (수정 모드)
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (sentences.length === 0) {
                alert('최소 1개 이상의 문장을 추가해주세요.');
                return;
            }

            showLoadingSpinner('테스트 수정 중...');

            try {
                const testData = gatherTestData();
                
                // Firebase에서 테스트 수정
                await db.collection('tests').doc(currentTestCode).update(testData);
                
                hideLoadingSpinner();
                showSuccessModal();
                
            } catch (error) {
                console.error('테스트 수정 오류:', error);
                hideLoadingSpinner();
                alert('테스트 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 테스트 데이터 수집
        function gatherTestData() {
            // 시간 제한 처리
            let timeLimit = null;
            const timeLimitSelect = document.getElementById('timeLimit').value;
            if (timeLimitSelect === 'custom') {
                const customTime = parseInt(document.getElementById('customTimeLimit').value);
                if (customTime > 0) {
                    timeLimit = customTime * 60; // 분을 초로 변환
                }
            } else if (timeLimitSelect) {
                timeLimit = parseInt(timeLimitSelect);
            }

            return {
                title: document.getElementById('testTitle').value.trim(),
                description: document.getElementById('testDescription').value.trim(),
                sentences: sentences,
                settings: {
                    timeLimit: timeLimit,
                    allowRetry: document.getElementById('allowRetry')?.checked || false,
                    showResultsImmediately: document.getElementById('showResultsImmediately')?.checked !== false,
                    speechRate: parseFloat(document.getElementById('speechRate')?.value || '1.0'),
                    scoring: {
                        caseSensitive: document.getElementById('caseSensitive').checked,
                        checkPunctuation: document.getElementById('checkPunctuation').checked,
                        ignoreSpaces: document.getElementById('ignoreSpaces').checked,
                        partialCredit: document.getElementById('partialCredit').checked
                    }
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
        }

        // 시간 제한 변경 처리
        function handleTimeLimitChange() {
            const timeLimit = document.getElementById('timeLimit').value;
            const customInput = document.getElementById('customTimeLimit');
            
            if (timeLimit === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                customInput.value = '';
            }
            updatePreview();
        }        // 문장 추가
        function addSentence(text = '', difficulty = 'medium', category = 'general') {
            console.log('addSentence 함수 호출됨:', { text, difficulty, category });
            sentenceCounter++;
            const sentence = {
                id: `sentence_${sentenceCounter}`,
                text: text,
                order: sentences.length + 1,
                difficulty: difficulty,
                category: category
            };

            sentences.push(sentence);
            console.log('문장 추가됨:', sentence);
            console.log('현재 문장 목록:', sentences);
            renderSentences();
            updatePreview();
        }

        // 문장 목록 렌더링
        function renderSentences() {
            const container = document.getElementById('sentencesList');
            const emptyState = document.getElementById('emptySentencesState');

            if (sentences.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            container.innerHTML = sentences.map((sentence, index) => `
                <div class="sentence-item bg-gray-50 border border-gray-200 rounded-lg p-4" data-id="${sentence.id}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 pr-4">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="sentence-number bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">
                                    ${index + 1}
                                </span>
                                <button 
                                    type="button"
                                    onclick="testSentenceSpeech('${sentence.id}')"
                                    class="test-speech-btn text-green-600 hover:text-green-700 text-sm"
                                    title="음성 테스트"
                                >
                                    🔊 테스트
                                </button>
                                <select 
                                    onchange="updateSentenceDifficulty('${sentence.id}', this.value)"
                                    class="text-xs border border-gray-300 rounded px-2 py-1"
                                >
                                    <option value="easy" ${sentence.difficulty === 'easy' ? 'selected' : ''}>쉬움</option>
                                    <option value="medium" ${sentence.difficulty === 'medium' ? 'selected' : ''}>보통</option>
                                    <option value="hard" ${sentence.difficulty === 'hard' ? 'selected' : ''}>어려움</option>
                                </select>
                            </div>
                            <textarea 
                                onchange="updateSentenceText('${sentence.id}', this.value)"
                                class="w-full p-2 text-sm border border-gray-300 rounded resize-none"
                                rows="2"
                                placeholder="문장을 입력하세요..."
                            >${sentence.text}</textarea>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button 
                                type="button"
                                onclick="removeSentence('${sentence.id}')"
                                class="text-red-500 hover:text-red-700 text-sm p-1"
                                title="문장 삭제"
                            >
                                🗑️
                            </button>
                            <div class="drag-handle cursor-move text-gray-400 text-sm p-1" title="드래그하여 순서 변경">
                                ⋮⋮
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            updateSentenceNumbers();
        }

        // 나머지 함수들...
        function updatePreview() {
            const title = document.getElementById('testTitle').value || '제목 없음';
            const timeLimit = getTimeLimitText();
            const allowRetry = document.getElementById('allowRetry').checked ? '허용' : '불허용';
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewSentenceCount').textContent = sentences.length;
            document.getElementById('previewTimeLimit').textContent = timeLimit;
            document.getElementById('previewAllowRetry').textContent = allowRetry;
            document.getElementById('sentenceCount').textContent = sentences.length;
        }

        function getTimeLimitText() {
            const timeLimit = document.getElementById('timeLimit').value;
            if (!timeLimit) return '제한 없음';
            if (timeLimit === 'custom') {
                const customTime = document.getElementById('customTimeLimit').value;
                return customTime ? `${customTime}분` : '제한 없음';
            }
            return `${Math.floor(parseInt(timeLimit) / 60)}분`;
        }

        function showLoadingSpinner(text = '처리 중...') {
            const spinner = document.getElementById('loadingSpinner');
            spinner.querySelector('span').textContent = text;
            spinner.style.display = 'flex';
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            document.getElementById('modalTestTitle').textContent = document.getElementById('testTitle').value;
            document.getElementById('modalTestCode').textContent = currentTestCode;
            modal.style.display = 'flex';
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }        function goToMonitoring() {
            window.location.href = `monitor.html?code=${currentTestCode}`;
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        function logout() {
            auth.signOut();
        }

        // 문장 관련 함수들
        function updateSentenceText(id, text) {
            const sentence = sentences.find(s => s.id === id);
            if (sentence) {
                sentence.text = text;
                updatePreview();
            }
        }

        function updateSentenceDifficulty(id, difficulty) {
            const sentence = sentences.find(s => s.id === id);
            if (sentence) {
                sentence.difficulty = difficulty;
            }
        }

        function removeSentence(id) {
            sentences = sentences.filter(s => s.id !== id);
            renderSentences();
            updatePreview();
        }

        function testSentenceSpeech(sentenceId) {
            const sentence = sentences.find(s => s.id === sentenceId);
            if (sentence && sentence.text) {
                testSpeech(sentence.text);
            } else {
                alert('문장을 입력해야 합니다.');
            }
        }

        function testSpeech(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = parseFloat(document.getElementById('speechRate').value) || 1.0;
                speechSynthesis.speak(utterance);
            } else {
                alert('이 브라우저는 음성 합성을 지원하지 않습니다.');
            }
        }

        function updateSentenceNumbers() {
            sentences.forEach((sentence, index) => {
                sentence.order = index + 1;
            });
        }

        function initializeSortable() {
            const container = document.getElementById('sentencesList');
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = new Sortable(container, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function(evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        const movedSentence = sentences.splice(oldIndex, 1)[0];
                        sentences.splice(newIndex, 0, movedSentence);
                        updateSentenceNumbers();
                        renderSentences();
                        updatePreview();
                    }
                }
            });
        }

        function importSentences() {
            document.getElementById('importModal').style.display = 'flex';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('sentenceFile').value = '';
            document.getElementById('bulkSentences').value = '';
        }

        function processSentenceImport() {
            const fileInput = document.getElementById('sentenceFile');
            const textInput = document.getElementById('bulkSentences').value.trim();
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    processSentenceText(text);
                };
                reader.readAsText(file);
            } else if (textInput) {
                processSentenceText(textInput);
            } else {
                alert('파일을 선택하거나 텍스트를 입력해주세요.');
                return;
            }
            
            closeImportModal();
        }

        function processSentenceText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            lines.forEach(line => {
                if (line.trim()) {
                    addSentence(line.trim());
                }
            });
        }

        function copyTestCode() {
            navigator.clipboard.writeText(currentTestCode).then(() => {
                alert('테스트 코드가 복사되었습니다!');
            }).catch(err => {
                console.error('복사 실패:', err);
            });
        }
    </script>
</body>
</html>
