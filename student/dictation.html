<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸ - ì˜ì–´ ë°›ì•„ì“°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .question-card {
            transition: all 0.3s ease;
            min-height: 400px;
        }
        .audio-controls {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .timer {
            animation: pulse 1s ease-in-out infinite;
        }
        .answer-input {
            font-size: 18px;
            line-height: 1.5;
            min-height: 120px;
        }
        .play-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            transition: all 0.3s ease;
        }
        .play-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }
        .play-button:active {
            transform: scale(0.95);
        }
        .sentence-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .navigation-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            backdrop-filter: blur(10px);
        }
        .feedback-correct {
            background-color: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        .feedback-incorrect {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }
        .loading-dots {
            animation: loading 1.4s infinite ease-in-out both;
        }
        .loading-dots:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots:nth-child(2) { animation-delay: -0.16s; }        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .modal-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-body {
            padding: 1rem 0;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-secondary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 id="testTitle" class="text-xl font-semibold text-gray-900">ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸</h1>
                    <span id="studentInfo" class="ml-4 text-sm text-gray-600"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- ì§„í–‰ë¥  -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">ì§„í–‰ë¥ :</span>
                        <div class="w-24 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="progressText" class="text-sm font-medium text-gray-700">0/0</span>
                    </div>
                    <!-- íƒ€ì´ë¨¸ -->
                    <div class="timer bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="timeRemaining">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ì‹œê°„ ì§„í–‰ ìƒí™© í”„ë¡œê·¸ë˜ìŠ¤ ë°” -->
    <div id="timeProgressContainer" class="hidden bg-white border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-3">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-700">ì‹œê°„ ì§„í–‰ ìƒí™©</span>
                    <span id="timeProgressText" class="text-sm text-gray-600">ë‚¨ì€ ì‹œê°„: <span id="timeRemainingText">--:--</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="timeProgressBar" class="bg-gradient-to-r from-green-500 to-yellow-500 h-2 rounded-full transition-all duration-1000" style="width: 100%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>ì‹œì‘</span>
                    <span id="halfTimeMarker" class="hidden">ì¤‘ê°„</span>
                    <span>ì¢…ë£Œ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="test-container py-8 px-4 sm:px-6 lg:px-8">
        <!-- í…ŒìŠ¤íŠ¸ ì‹œì‘ ì „ ì•ˆë‚´ -->
        <div id="startScreen" class="bg-white rounded-xl shadow-lg p-8 text-center">
            <div class="mb-6">
                <i class="fas fa-headphones text-6xl text-blue-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸</h2>
                <p class="text-gray-600">ì¤€ë¹„ê°€ ë˜ë©´ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="font-semibold text-gray-900 mb-3">í…ŒìŠ¤íŠ¸ ì•ˆë‚´</h3>                <ul class="text-left text-sm text-gray-600 space-y-2">
                    <li><i class="fas fa-check text-green-500 mr-2"></i>ê° ë¬¸ì¥ì€ ìµœëŒ€ 3ë²ˆê¹Œì§€ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>ë¬¸ì¥ì„ ë“£ê³  ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>ëŒ€ì†Œë¬¸ìì™€ êµ¬ë‘ì ì— ì£¼ì˜í•´ì£¼ì„¸ìš”</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>ì…ë ¥ í›„ ë‹¤ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§„í–‰í•˜ì„¸ìš”</li>
                </ul>
                
                <!-- ì‹œê°„ ì œí•œ ì •ë³´ (ë³„ë„ ê°•ì¡°) -->
                <div id="timeLimitInfo" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-blue-500 mr-2"></i>
                        <span class="font-medium text-blue-800">ì œí•œ ì‹œê°„: <span id="timeLimitDisplay">í™•ì¸ ì¤‘...</span></span>
                    </div>
                </div>
            </div>            <div class="space-y-4">
                <button id="startTestBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-play mr-2"></i>í…ŒìŠ¤íŠ¸ ì‹œì‘
                </button>
                <div>
                    <button id="testAudioBtn" class="text-blue-600 hover:text-blue-800 text-sm">
                        <i class="fas fa-volume-up mr-1"></i>ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸
                    </button>
                </div>
            </div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì§„í–‰ í™”ë©´ -->
        <div id="testScreen" class="hidden">
            <!-- ì§ˆë¬¸ ì¹´ë“œ -->
            <div class="question-card bg-white rounded-xl shadow-lg p-8 mb-6">
                <!-- ë¬¸ì œ ë²ˆí˜¸ ë° ì •ë³´ -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">
                            ë¬¸ì œ <span id="currentQuestionNumber">1</span> / <span id="totalQuestions">0</span>
                        </h3>
                        <p class="text-sm text-gray-600 mt-1">
                            ë‚œì´ë„: <span id="currentDifficulty" class="difficulty-badge">ë³´í†µ</span>
                        </p>
                    </div>
                    <div class="text-sm text-gray-600">
                        ì¬ìƒ íšŸìˆ˜: <span id="playCount">0</span> / 3
                    </div>
                </div>

                <!-- ì˜¤ë””ì˜¤ ì»¨íŠ¸ë¡¤ -->
                <div class="audio-controls rounded-xl p-8 text-white text-center mb-6">
                    <div class="mb-4">
                        <p class="text-white/80 mb-2">ë¬¸ì¥ì„ ë“£ê³  ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”</p>
                        <div id="sentenceDisplay" class="sentence-display rounded-lg p-4 text-center hidden">
                            <p id="currentSentence" class="text-lg"></p>
                        </div>
                    </div>
                    
                    <div class="flex justify-center items-center space-x-4">
                        <button id="playButton" class="play-button flex items-center justify-center text-white hover:text-white">
                            <i class="fas fa-play text-2xl"></i>
                        </button>
                        <div class="text-center">
                            <div id="audioStatus" class="text-sm text-white/80 mb-1">ì¬ìƒì„ ìœ„í•´ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                            <div id="audioProgress" class="w-32 bg-white/20 rounded-full h-2 hidden">
                                <div id="audioProgressBar" class="bg-white h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>                    <!-- ì¶”ê°€ ì»¨íŠ¸ë¡¤ -->
                    <div class="flex justify-center space-x-4 mt-4">
                        <button id="speedSlowBtn" class="text-white/70 hover:text-white text-sm">
                            <i class="fas fa-backward mr-1"></i>ëŠë¦¬ê²Œ
                        </button>
                        <button id="speedNormalBtn" class="text-white text-sm border-b border-white/50">
                            <i class="fas fa-play mr-1"></i>ë³´í†µ
                        </button>
                        <button id="speedFastBtn" class="text-white/70 hover:text-white text-sm">
                            <i class="fas fa-forward mr-1"></i>ë¹ ë¥´ê²Œ
                        </button>
                    </div>
                </div>

                <!-- ë‹µì•ˆ ì…ë ¥ -->
                <div class="mb-6">
                    <label for="answerInput" class="block text-sm font-medium text-gray-700 mb-2">
                        ë‹µì•ˆ ì…ë ¥
                    </label>
                    <textarea id="answerInput" 
                              class="answer-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                              placeholder="ë“¤ì€ ë¬¸ì¥ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”..."
                              rows="4"></textarea>
                    
                    <!-- ì…ë ¥ ë„ì›€ë§ -->
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-lightbulb mr-1"></i>
                        íŒ: ë‹µì•ˆì„ ì •í™•íˆ ì…ë ¥í•œ í›„ ì œì¶œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </div>
                </div>

                <!-- ë‹µì•ˆ í™•ì¸ ì˜ì—­ -->
                <div id="answerFeedback" class="hidden mb-6 p-4 rounded-lg border-2">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold">ë‹µì•ˆ í™•ì¸</h4>
                        <span id="questionScore" class="text-lg font-bold"></span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div><strong>ì›ë¬¸:</strong> <span id="originalSentence"></span></div>
                        <div><strong>ì…ë ¥:</strong> <span id="userAnswer"></span></div>
                        <div id="differences" class="hidden"><strong>ì°¨ì´ì :</strong> <span id="differenceDetails"></span></div>
                    </div>
                </div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
            <div class="navigation-buttons p-4">
                <div class="flex justify-between">
                    <button id="prevButton" class="btn-secondary" disabled>
                        <i class="fas fa-chevron-left mr-2"></i>ì´ì „
                    </button>
                    
                    <div class="flex space-x-3">
                        <button id="showAnswerBtn" class="btn-secondary hidden">
                            <i class="fas fa-eye mr-2"></i>ì •ë‹µ ë³´ê¸°
                        </button>
                        <button id="submitAnswerBtn" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>ë‹µì•ˆ ì œì¶œ
                        </button>
                        <button id="nextButton" class="btn-primary hidden">
                            <i class="fas fa-chevron-right mr-2"></i>ë‹¤ìŒ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í™”ë©´ -->
        <div id="completionScreen" class="hidden bg-white rounded-xl shadow-lg p-8 text-center">
            <div class="mb-6">
                <i class="fas fa-trophy text-6xl text-yellow-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</h2>
                <p class="text-gray-600">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 rounded-lg p-6">
                    <div class="text-3xl font-bold text-blue-600 mb-2" id="finalScore">0%</div>
                    <div class="text-sm text-gray-600">ìµœì¢… ì ìˆ˜</div>
                </div>
                <div class="bg-green-50 rounded-lg p-6">
                    <div class="text-3xl font-bold text-green-600 mb-2" id="correctAnswers">0</div>
                    <div class="text-sm text-gray-600">ì •ë‹µ ê°œìˆ˜</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-6">
                    <div class="text-3xl font-bold text-purple-600 mb-2" id="testDuration">0ë¶„</div>
                    <div class="text-sm text-gray-600">ì†Œìš” ì‹œê°„</div>
                </div>
            </div>

            <div class="space-y-4">
                <button id="viewDetailsBtn" class="btn-primary mr-4">
                    <i class="fas fa-chart-bar mr-2"></i>ìƒì„¸ ê²°ê³¼ ë³´ê¸°
                </button>
                <button id="retryTestBtn" class="btn-secondary hidden">
                    <i class="fas fa-redo mr-2"></i>ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        </div>
    </main>

    <!-- ë¡œë”© ëª¨ë‹¬ -->
    <div id="loadingModal" class="modal">
        <div class="modal-content max-w-sm">
            <div class="text-center py-8">
                <div class="flex justify-center space-x-2 mb-4">
                    <div class="loading-dots w-2 h-2 bg-blue-600 rounded-full"></div>
                    <div class="loading-dots w-2 h-2 bg-blue-600 rounded-full"></div>
                    <div class="loading-dots w-2 h-2 bg-blue-600 rounded-full"></div>
                </div>
                <p id="loadingMessage" class="text-gray-600">í…ŒìŠ¤íŠ¸ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <!-- ì‹œê°„ ê²½ê³  ëª¨ë‹¬ -->
    <div id="timeWarningModal" class="modal">
        <div class="modal-content max-w-sm">
            <div class="modal-header">
                <h3 class="text-red-600">
                    <i class="fas fa-exclamation-triangle mr-2"></i>ì‹œê°„ ê²½ê³ 
                </h3>
            </div>
            <div class="modal-body text-center">
                <p class="mb-4">ë‚¨ì€ ì‹œê°„ì´ <span id="warningTime">5ë¶„</span> ì…ë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-600">ì„œë‘˜ëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.</p>
                <button id="closeTimeWarning" class="btn-primary mt-4">í™•ì¸</button>
            </div>
        </div>    </div>    <!-- Firebase ì„¤ì • ë° ì´ˆê¸°í™” -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/scoring.js"></script>
      <script>
        // ì „ì—­ ë³€ìˆ˜
        let testData = null;
        let participantData = null;
        let currentQuestionIndex = 0;
        let answers = [];
        let playCount = 0;
        let maxPlayCount = 3;
        let testStartTime = null;
        let testTimer = null;
        let timeLimit = 30; // ê¸°ë³¸ 30ë¶„        
        let currentSpeechRate = 0.8; // ê¸°ë³¸ ì†ë„ë¥¼ 'ëŠë¦¬ê²Œ'ë¡œ ë³€ê²½ (ê¸°ì¡´ ëŠë¦¬ê²Œì˜€ë˜ ì†ë„)
        let currentUtterance = null;
        let isTestPaused = false; // í…ŒìŠ¤íŠ¸ ì¼ì‹œì •ì§€ ìƒíƒœ
        let playCountStorage = {}; // ë¬¸ì œë³„ ì¬ìƒ íšŸìˆ˜ ì €ì¥// ì„¸ì…˜ ë°ì´í„°
        let studentSession = JSON.parse(sessionStorage.getItem('studentSession') || '{}');        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ ===');
            console.log('í˜„ì¬ URL:', window.location.href);
            console.log('URL íŒŒë¼ë¯¸í„°:', window.location.search);
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¸ì…˜ ì •ë³´ ë³µì› ì‹œë„
            restoreSessionFromURL();
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            waitForFirebase();
        });

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¸ì…˜ ì •ë³´ ë³µì›
        function restoreSessionFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const testCode = urlParams.get('testCode');
            const participantId = urlParams.get('participantId');
            const participantName = urlParams.get('participantName');
            
            // URL íŒŒë¼ë¯¸í„°ê°€ ìˆê³  ì„¸ì…˜ ì •ë³´ê°€ ì—†ê±°ë‚˜ ë¶ˆì™„ì „í•œ ê²½ìš°
            if (testCode && participantId && (!studentSession.testCode || !studentSession.participantId)) {
                console.log('URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¸ì…˜ ì •ë³´ ë³µì›:', {
                    testCode, 
                    participantId, 
                    participantName
                });
                
                // ì„¸ì…˜ ì •ë³´ ë³µì›
                studentSession = {
                    testCode: testCode,
                    participantId: participantId,
                    participantName: participantName || 'Unknown',
                    authenticatedAt: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000), // 24ì‹œê°„ í›„ ë§Œë£Œ
                    restoredFromURL: true
                };
                
                // sessionStorageì— ì €ì¥
                sessionStorage.setItem('studentSession', JSON.stringify(studentSession));
                
                // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ë³´ì•ˆìƒ ì´ìœ ë¡œ)
                const newURL = window.location.pathname;
                window.history.replaceState({}, document.title, newURL);
                
                console.log('URL ê¸°ë°˜ ì„¸ì…˜ ë³µì› ì™„ë£Œ');
            }
        }        function waitForFirebase() {
            console.log('=== Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì‹œì‘ ===');
            console.log('Firebase íƒ€ì…:', typeof firebase);
            console.log('DB íƒ€ì…:', typeof db);
            
            // Firebaseì™€ Firestoreê°€ ëª¨ë‘ ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ (ìµœëŒ€ 10ì´ˆ)
            let attempts = 0;
            const maxAttempts = 20; // 10ì´ˆ (500ms * 20)
            
            function checkFirebase() {
                attempts++;
                
                if (typeof firebase !== 'undefined' && typeof db !== 'undefined') {
                    console.log('=== Firebase ì´ˆê¸°í™” ì™„ë£Œ ===');
                    console.log('Firebase ì•±:', firebase.apps.length > 0 ? 'ì´ˆê¸°í™”ë¨' : 'ì´ˆê¸°í™” ì•ˆë¨');
                    console.log('Firestore DB:', db ? 'ì‚¬ìš© ê°€ëŠ¥' : 'ì‚¬ìš© ë¶ˆê°€');
                    
                    initializeApp();
                    return;
                }
                
                if (attempts >= maxAttempts) {
                    console.warn('=== Firebase ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼ - ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰ ===');
                    console.log('Firebase ì—†ì´ ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
                    initializeApp();
                    return;
                }
                
                console.log(`Firebase ë¡œë”© ì¤‘... (${attempts}/${maxAttempts})`);
                setTimeout(checkFirebase, 500);
            }
            
            checkFirebase();
        }        function initializeApp() {
            console.log('=== ì•± ì´ˆê¸°í™” ì‹œì‘ ===');
            console.log('í˜„ì¬ studentSession:', studentSession);
            
            // ì„¸ì…˜ ê²€ì¦
            if (!validateSession()) {
                console.error('ì„¸ì…˜ ê²€ì¦ ì‹¤íŒ¨ - ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '../index.html';
                return;
            }

            console.log('ì„¸ì…˜ ê²€ì¦ ì„±ê³µ');
            if (studentSession.testCode) {
                console.log('í…ŒìŠ¤íŠ¸ ì½”ë“œ:', studentSession.testCode);
                console.log('ì°¸ì—¬ì ID:', studentSession.participantId);
                console.log('ì°¸ì—¬ì ì´ë¦„:', studentSession.participantName);
            } else {
                console.log('ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰');
            }

            initializeTest();
            initializeEventListeners();
            
            console.log('=== ì•± ì´ˆê¸°í™” ì™„ë£Œ ===');
        }// ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦
        function validateSession() {
            console.log('=== ì„¸ì…˜ ê²€ì¦ ì‹œì‘ ===');
            console.log('studentSession:', studentSession);
            
            // ì„¸ì…˜ ì •ë³´ê°€ ì „í˜€ ì—†ëŠ” ê²½ìš°
            if (!studentSession || Object.keys(studentSession).length === 0) {
                console.log('ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. URL íŒŒë¼ë¯¸í„° í™•ì¸...');
                
                // URL íŒŒë¼ë¯¸í„° ì¬í™•ì¸
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('testCode') && urlParams.get('participantId')) {
                    console.log('URL íŒŒë¼ë¯¸í„° ì¡´ì¬ - ì„¸ì…˜ ë³µì› ì¬ì‹œë„');
                    restoreSessionFromURL();
                    return studentSession && studentSession.testCode && studentSession.participantId;
                }
                
                console.log('URL íŒŒë¼ë¯¸í„°ë„ ì—†ìŒ - ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰');
                return true; // ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰
            }

            // ê¸°ë³¸ í•„ìˆ˜ ì •ë³´ í™•ì¸
            if (!studentSession.testCode || !studentSession.participantId) {
                console.log('í•„ìˆ˜ ì„¸ì…˜ ì •ë³´ ëˆ„ë½ - ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰');
                return true; // ìƒ˜í”Œ ëª¨ë“œë¡œ ì§„í–‰
            }

            // ì„¸ì…˜ ë§Œë£Œ ê²€ì¦ (URL ë³µì›ëœ ì„¸ì…˜ì€ ë” ê´€ëŒ€í•˜ê²Œ)
            if (studentSession.expiresAt && Date.now() > studentSession.expiresAt) {
                console.warn('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                if (!studentSession.restoredFromURL && !studentSession.sampleMode) {
                    sessionStorage.removeItem('studentSession');
                    sessionStorage.removeItem('studentInfo');
                    return false;
                }
            }

            // ì¸ì¦ ì‹œê°„ ê²€ì¦ (URL ë³µì›ëœ ì„¸ì…˜ì€ 48ì‹œê°„, ì¼ë°˜ ì„¸ì…˜ì€ 24ì‹œê°„)
            if (studentSession.authenticatedAt) {
                const maxAge = studentSession.restoredFromURL ? (48 * 60 * 60 * 1000) : (24 * 60 * 60 * 1000);
                if ((Date.now() - studentSession.authenticatedAt) > maxAge) {
                    console.warn('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    if (!studentSession.sampleMode) {
                        return false;
                    }
                }
            }

            console.log('=== ì„¸ì…˜ ê²€ì¦ ì™„ë£Œ ===');
            return true;
        }// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¬ìƒ íšŸìˆ˜ ë°ì´í„° ë¡œë“œ
        function loadPlayCountsFromStorage() {
            try {
                // studentSession ìœ íš¨ì„± í™•ì¸
                if (!studentSession || !studentSession.testCode || !studentSession.participantId) {
                    console.warn('studentSession ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤:', studentSession);
                    playCountStorage = {};
                    return;
                }
                
                const storageKey = `playCount_${studentSession.testCode}_${studentSession.participantId}`;
                const stored = localStorage.getItem(storageKey);
                if (stored) {
                    playCountStorage = JSON.parse(stored);
                } else {
                    playCountStorage = {};
                }
            } catch (error) {
                console.error('ì¬ìƒ íšŸìˆ˜ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                playCountStorage = {};
            }
        }        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¬ìƒ íšŸìˆ˜ ë°ì´í„° ì €ì¥
        function savePlayCountsToStorage() {
            try {
                // studentSession ìœ íš¨ì„± í™•ì¸
                if (!studentSession || !studentSession.testCode || !studentSession.participantId) {
                    console.warn('studentSession ì •ë³´ê°€ ë¶ˆì™„ì „í•˜ì—¬ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', studentSession);
                    return;
                }
                
                const storageKey = `playCount_${studentSession.testCode}_${studentSession.participantId}`;
                localStorage.setItem(storageKey, JSON.stringify(playCountStorage));
            } catch (error) {
                console.error('ì¬ìƒ íšŸìˆ˜ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        // í˜„ì¬ ë¬¸ì œì˜ ì¬ìƒ íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°
        function getCurrentQuestionPlayCount() {
            const questionKey = `q_${currentQuestionIndex}`;
            return playCountStorage[questionKey] || 0;
        }

        // í˜„ì¬ ë¬¸ì œì˜ ì¬ìƒ íšŸìˆ˜ ì¦ê°€
        function incrementCurrentQuestionPlayCount() {
            const questionKey = `q_${currentQuestionIndex}`;
            playCountStorage[questionKey] = (playCountStorage[questionKey] || 0) + 1;
            savePlayCountsToStorage();
        }        // í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”
        async function initializeTest() {
            try {
                console.log('=== í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹œì‘ ===');
                console.log('studentSession:', studentSession);
                console.log('Firebase db íƒ€ì…:', typeof db);
                
                showLoading('í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                // Firebase db ê°ì²´ í™•ì¸
                if (typeof db === 'undefined') {
                    console.error('âŒ Firebase ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    alert('âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    throw new Error('Firebase ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                // studentSession í™•ì¸
                if (!studentSession || !studentSession.testCode) {
                    console.error('âŒ ì„¸ì…˜ ì •ë³´ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤:', {
                        hasSession: !!studentSession,
                        testCode: studentSession?.testCode,
                        participantId: studentSession?.participantId
                    });
                    alert('âŒ ì„¸ì…˜ ì •ë³´ ì˜¤ë¥˜: í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    // ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ ì§„í–‰
                    await initializeSampleTest();
                    return;
                }
                  console.log('ğŸ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¡œ ë¬¸ì„œ ì¡°íšŒ ì‹œì‘:', studentSession.testCode);
                
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì‹œë„
                try {
                    const testDoc = await db.collection('tests').doc(studentSession.testCode).get();
                    console.log('ğŸ“„ í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì¡°íšŒ ì™„ë£Œ. exists:', testDoc.exists);
                    
                    if (!testDoc.exists) {
                        console.error('âŒ í…ŒìŠ¤íŠ¸ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½”ë“œ:', studentSession.testCode);
                        alert(`âŒ í…ŒìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì…ë ¥í•œ ì½”ë“œ: ${studentSession.testCode}\n\nì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                        await initializeSampleTest();
                        return;
                    }
                    
                    testData = testDoc.data();
                    console.log('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', {
                        title: testData.title,
                        sentenceCount: testData.sentences?.length || 0,
                        isActive: testData.isActive
                    });
                    
                    // í…ŒìŠ¤íŠ¸ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    if (!testData.isActive) {
                        console.error('âŒ ë¹„í™œì„±í™”ëœ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.');
                        alert('âŒ ì´ í…ŒìŠ¤íŠ¸ëŠ” í˜„ì¬ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                        await initializeSampleTest();
                        return;
                    }

                    // ì°¸ì—¬ì ë°ì´í„°ëŠ” í…ŒìŠ¤íŠ¸ ë¬¸ì„œì˜ participants í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    const participants = testData.participants || {};
                    participantData = participants[studentSession.participantId];
                    
                    if (!participantData) {
                        console.warn('ì°¸ì—¬ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì°¸ì—¬ìë¡œ ìƒì„±í•©ë‹ˆë‹¤.');
                        participantData = {
                            name: studentSession.participantName || 'Test Student',
                            studentId: 'TEST001',
                            status: 'pending',
                            joinedAt: new Date(),
                            answers: [],
                            score: 0
                        };
                    }

                    // UI ì´ˆê¸°í™”
                    await initializeUI();
                      } catch (firebaseError) {
                    console.error('âŒ Firebase ì—°ê²° ì‹¤íŒ¨:', firebaseError);
                    alert(`âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ${firebaseError.message}\n\nìƒ˜í”Œ í…ŒìŠ¤íŠ¸ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.`);
                    console.log('ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ ì§„í–‰í•©ë‹ˆë‹¤.');
                    await initializeSampleTest();
                    return;
                }
                
                hideLoading();
                console.log('=== í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ ===');
                    } catch (error) {
                console.error('âŒ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert(`âŒ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}\n\nìƒ˜í”Œ í…ŒìŠ¤íŠ¸ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.`);
                console.log('ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.');
                
                try {
                    await initializeSampleTest();
                } catch (sampleError) {
                    console.error('âŒ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”ë„ ì‹¤íŒ¨:', sampleError);
                    alert('âŒ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    hideLoading();
                }
            }
        }        // ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
        async function initializeSampleTest() {
            console.log('âš ï¸ === ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” === âš ï¸');
            console.warn('ì£¼ì˜: ì‹¤ì œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•´ 5ë¬¸ì œ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.');
            
            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            if (studentSession && studentSession.testCode && studentSession.testCode !== 'SAMPLE_TEST') {
                console.warn(`ì›ë˜ ìš”ì²­ëœ í…ŒìŠ¤íŠ¸ ì½”ë“œ: ${studentSession.testCode}`);
                alert(`âš ï¸ ì›ë˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ(${studentSession.testCode})ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ 5ë¬¸ì œ ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.\n\nì‹¤ì œ í…ŒìŠ¤íŠ¸ë¥¼ ì›í•˜ì‹ ë‹¤ë©´:\n1. í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì •í™•í•œì§€ í™•ì¸\n2. í…ŒìŠ¤íŠ¸ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸\n3. ì¸í„°ë„· ì—°ê²° ìƒíƒœ í™•ì¸\n4. ì„ ìƒë‹˜ê»˜ ë¬¸ì˜`);
            }
            
            // ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ë°ì´í„°
            testData = {
                title: 'ìƒ˜í”Œ ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸',
                settings: {
                    timeLimit: 1800, // 30ë¶„ (ì´ˆ ë‹¨ìœ„)
                    allowRetries: true,
                    maxAttempts: 3
                },
                sentences: [
                    { 
                        text: "Hello, how are you today?",
                        difficulty: "easy",
                        points: 10
                    },
                    { 
                        text: "The weather is very nice today.",
                        difficulty: "easy", 
                        points: 10
                    },
                    { 
                        text: "I like to read books in the evening.",
                        difficulty: "medium",
                        points: 15
                    },
                    { 
                        text: "She has been studying English for three years.",
                        difficulty: "medium",
                        points: 15
                    },
                    { 
                        text: "The sophisticated technology revolutionized our understanding.",
                        difficulty: "hard",
                        points: 20
                    }
                ],
                createdAt: new Date(),
                createdBy: 'system'
            };
            
            // ìƒ˜í”Œ ì°¸ì—¬ì ë°ì´í„°
            participantData = {
                name: studentSession.participantName || 'Sample Student',
                studentId: studentSession.participantId || 'SAMPLE001',
                status: 'pending',
                joinedAt: new Date(),
                answers: [],
                score: 0
            };
            
            // ì„¸ì…˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ìƒ˜í”Œë¡œ ìƒì„±
            if (!studentSession.testCode) {
                studentSession = {
                    testCode: 'SAMPLE_TEST',
                    participantId: 'sample001',
                    participantName: 'Sample Student',
                    authenticatedAt: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000),
                    sampleMode: true
                };
                sessionStorage.setItem('studentSession', JSON.stringify(studentSession));
            }
            
            console.log('ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ë°ì´í„°:', testData);
            console.log('ìƒ˜í”Œ ì°¸ì—¬ì ë°ì´í„°:', participantData);
            
            // UI ì´ˆê¸°í™”
            await initializeUI();
            hideLoading();
            
            console.log('=== ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ ===');
        }// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProgress() {
            try {
                const totalQuestions = testData?.sentences?.length || 0;
                const currentProgress = Math.min(currentQuestionIndex, totalQuestions);
                const progressPercentage = totalQuestions > 0 ? (currentProgress / totalQuestions) * 100 : 0;
                
                // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.style.width = progressPercentage + '%';
                }
                
                // ì§„í–‰ë¥  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                const progressText = document.getElementById('progressText');
                if (progressText) {
                    progressText.textContent = `${currentProgress} / ${totalQuestions}`;
                }
                
                console.log(`ì§„í–‰ë¥  ì—…ë°ì´íŠ¸: ${currentProgress}/${totalQuestions} (${progressPercentage.toFixed(1)}%)`);
                
            } catch (error) {
                console.error('ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }        // UI ì´ˆê¸°í™”
        async function initializeUI() {
            // í—¤ë” ì •ë³´
            document.getElementById('testTitle').textContent = testData.title || 'ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸';
            document.getElementById('studentInfo').textContent = 
                `${participantData.name} (${participantData.studentId})`;            // ì‹œê°„ ì œí•œ ì„¤ì • (null ì²´í¬ë¥¼ ì •í™•íˆ ìˆ˜í–‰)
            const testTimeLimit = testData.settings?.timeLimit;
            
            console.log('ì‹œê°„ ì œí•œ ë°ì´í„°:', {
                rawTimeLimit: testTimeLimit,
                type: typeof testTimeLimit,
                isNull: testTimeLimit === null,
                isUndefined: testTimeLimit === undefined
            });
            
            // timeLimitDisplay ìš”ì†Œ í™•ì¸
            const timeLimitDisplayElement = document.getElementById('timeLimitDisplay');
            if (!timeLimitDisplayElement) {
                console.error('timeLimitDisplay ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            if (testTimeLimit === null || testTimeLimit === undefined) {
                // ì‹œê°„ ì œí•œ ì—†ìŒ
                timeLimit = null;
                if (timeLimitDisplayElement) {
                    timeLimitDisplayElement.textContent = 'ì œí•œ ì—†ìŒ';
                }
                // ì‹œê°„ ì œí•œ ì •ë³´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                const timeLimitInfo = document.getElementById('timeLimitInfo');
                if (timeLimitInfo) {
                    timeLimitInfo.style.display = 'none';
                }
                // íƒ€ì´ë¨¸ UI ìˆ¨ê¸°ê¸°
                const timerElement = document.querySelector('.timer');
                if (timerElement) {
                    timerElement.style.display = 'none';
                }
                const timeProgressContainer = document.getElementById('timeProgressContainer');
                if (timeProgressContainer) {
                    timeProgressContainer.style.display = 'none';
                }
                console.log('ì‹œê°„ ì œí•œ ì—†ìŒ - íƒ€ì´ë¨¸ UI ìˆ¨ê¹€');
            } else {
                // ì‹œê°„ ì œí•œ ìˆìŒ (ì´ˆ ë‹¨ìœ„ë¥¼ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜)
                timeLimit = Math.ceil(testTimeLimit / 60); // ì´ˆë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜
                if (timeLimitDisplayElement) {
                    timeLimitDisplayElement.textContent = timeLimit + 'ë¶„';
                }
                // ì‹œê°„ ì œí•œ ì •ë³´ ì„¹ì…˜ í‘œì‹œ
                const timeLimitInfo = document.getElementById('timeLimitInfo');
                if (timeLimitInfo) {
                    timeLimitInfo.style.display = 'block';
                }
                // íƒ€ì´ë¨¸ UI í‘œì‹œ
                const timerElement = document.querySelector('.timer');
                if (timerElement) {
                    timerElement.style.display = 'block';
                }
                const timeProgressContainer = document.getElementById('timeProgressContainer');
                if (timeProgressContainer) {
                    timeProgressContainer.classList.remove('hidden');
                }
                console.log(`ì‹œê°„ ì œí•œ ì„¤ì •: ${testTimeLimit}ì´ˆ = ${timeLimit}ë¶„`);
            }
              // í…ŒìŠ¤íŠ¸ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
            const startTestBtn = document.getElementById('startTestBtn');
            if (startTestBtn) {
                startTestBtn.disabled = false;
                startTestBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'disabled:opacity-50', 'disabled:cursor-not-allowed');
                startTestBtn.removeAttribute('disabled');
                console.log('í…ŒìŠ¤íŠ¸ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”ë¨');
            } else {
                console.error('startTestBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: 1ì´ˆ í›„ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸
            setTimeout(() => {
                const btn = document.getElementById('startTestBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.removeAttribute('disabled');
                    console.log('í…ŒìŠ¤íŠ¸ ì‹œì‘ ë²„íŠ¼ ì¬í™•ì¸ ì™„ë£Œ');
                }            }, 1000);
            
            // ì´ ë¬¸ì œ ìˆ˜ í‘œì‹œ
            const totalQuestionsElement = document.getElementById('totalQuestions');
            if (totalQuestionsElement) {
                totalQuestionsElement.textContent = testData.sentences?.length || 0;
            }

            // ì§„í–‰ë¥  ì´ˆê¸°í™”
            updateProgress();// ê¸°ì¡´ ë‹µì•ˆì´ ìˆìœ¼ë©´ ë³µì›
            if (participantData.answers) {
                answers = participantData.answers;
                currentQuestionIndex = answers.length;
                if (currentQuestionIndex >= testData.sentences.length) {
                    // ì´ë¯¸ ì™„ë£Œëœ í…ŒìŠ¤íŠ¸
                    showCompletionScreen();
                    return;
                }
            }            // ê¸°ì¡´ í…ŒìŠ¤íŠ¸ ì§„í–‰ ìƒí™© ë³µì› (ì‹œê°„ í¬í•¨)
            // 1. ì„œë²„ ë°ì´í„°ì—ì„œ ë³µì› (ìš°ì„ ìˆœìœ„)
            let useServerData = false;
            
            if (participantData.status === 'in-progress') {
                console.log('ì„œë²„ì—ì„œ ì§„í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ ë°œê²¬');
                
                // ì„œë²„ì—ì„œ ì‹¤ì œ ì‹œì‘ ì‹œê°„ ë³µì›
                if (participantData.actualStartTime) {
                    testStartTime = participantData.actualStartTime.toDate ? 
                        participantData.actualStartTime.toDate() : 
                        new Date(participantData.actualStartTime);
                    
                    console.log('ì„œë²„ì—ì„œ ë³µì›ëœ í…ŒìŠ¤íŠ¸ ì‹œì‘ ì‹œê°„:', testStartTime);
                    useServerData = true;
                }
                
                // ë‹µì•ˆ ë³µì›
                if (participantData.answers && Array.isArray(participantData.answers)) {
                    answers = participantData.answers;
                    currentQuestionIndex = participantData.currentQuestion || answers.length;
                    console.log(`ì„œë²„ì—ì„œ ë³µì›: ë‹µì•ˆ ${answers.length}ê°œ, í˜„ì¬ ë¬¸ì œ ${currentQuestionIndex}`);
                }
                
                // ì‹œê°„ ì œí•œì´ ìˆëŠ” ê²½ìš° ë‚¨ì€ ì‹œê°„ í™•ì¸
                if (timeLimit !== null && timeLimit !== undefined && testStartTime) {
                    const elapsedTime = Date.now() - testStartTime.getTime();
                    const totalTimeMs = timeLimit * 60 * 1000;
                    const remainingTime = totalTimeMs - elapsedTime;
                    
                    console.log(`ì„œë²„ ê¸°ë°˜ ì‹œê°„ ê³„ì‚°: ê²½ê³¼ ${Math.round(elapsedTime / 1000)}ì´ˆ, ë‚¨ì€ ${Math.round(remainingTime / 1000)}ì´ˆ`);
                    
                    if (remainingTime <= 0) {
                        console.log('ì„œë²„ í™•ì¸ ê²°ê³¼: ì‹œê°„ ì´ˆê³¼ - ìë™ ì œì¶œ');
                        alert('ì œí•œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ê°€ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
                        await submitTest(true);
                        return;
                    }
                }
            }
              // 2. localStorage ë°±ì—… í™•ì¸ (ì„œë²„ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì˜¤ë˜ëœ ê²½ìš°ì—ë§Œ)
            const backupKey = `dictation_progress_${studentSession.testCode}_${studentSession.participantId}`;
            const emergencyKey = `dictation_emergency_${studentSession.testCode}_${studentSession.participantId}`;
            
            // ì¼ë°˜ ë°±ì—…ê³¼ ê¸´ê¸‰ ë°±ì—… ëª¨ë‘ í™•ì¸
            const backupData = localStorage.getItem(backupKey);
            const emergencyData = localStorage.getItem(emergencyKey);
            
            if (!useServerData && (backupData || emergencyData)) {
                try {
                    // ë” ìµœì‹  ë°±ì—… ì„ íƒ
                    let selectedBackup = null;
                    let backupSource = '';
                    
                    if (backupData && emergencyData) {
                        const backup = JSON.parse(backupData);
                        const emergency = JSON.parse(emergencyData);
                        if (backup.lastSaveTime > emergency.lastSaveTime) {
                            selectedBackup = backup;
                            backupSource = 'normal';
                        } else {
                            selectedBackup = emergency;
                            backupSource = 'emergency';
                        }
                    } else if (backupData) {
                        selectedBackup = JSON.parse(backupData);
                        backupSource = 'normal';
                    } else if (emergencyData) {
                        selectedBackup = JSON.parse(emergencyData);
                        backupSource = 'emergency';
                    }
                    
                    if (selectedBackup) {
                        const backupAge = Date.now() - selectedBackup.lastSaveTime;
                        
                        // ë°±ì—…ì´ 10ë¶„ ì´ë‚´ì´ê³  ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš© (ê¸´ê¸‰ ë°±ì—…ì€ ë” ê´€ëŒ€í•˜ê²Œ)
                        const maxAge = backupSource === 'emergency' ? 600000 : 300000; // 10ë¶„ vs 5ë¶„
                        
                        if (backupAge < maxAge && selectedBackup.status === 'in-progress') {
                            console.log(`ì„œë²„ ë°ì´í„° ì—†ìŒ - ${backupSource} ë°±ì—… ì‚¬ìš© (${Math.round(backupAge/1000)}ì´ˆ ì „)`);
                            
                            // ë°±ì—… ë°ì´í„°ë¡œ ë³µì›
                            answers = selectedBackup.answers || [];
                            currentQuestionIndex = selectedBackup.currentQuestion || 0;
                            testStartTime = new Date(selectedBackup.actualStartTime);
                            
                            console.log('ë°±ì—…ì—ì„œ ë³µì›ëœ ë°ì´í„°:', {
                                answers: answers.length,
                                currentQuestion: currentQuestionIndex,
                                startTime: testStartTime,
                                source: backupSource
                            });
                            
                            // ë°±ì—… ë°ì´í„°ë¥¼ ì¦‰ì‹œ ì„œë²„ì— ë™ê¸°í™”
                            setTimeout(async () => {
                                await saveProgressImmediate();
                                console.log('ë°±ì—… ë°ì´í„° ì„œë²„ ë™ê¸°í™” ì™„ë£Œ');
                            }, 1000);
                        }
                    }
                } catch (error) {
                    console.error('ë°±ì—… ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                }
                
                // ë°±ì—… ë°ì´í„° ì •ë¦¬
                localStorage.removeItem(backupKey);
                localStorage.removeItem(emergencyKey);
            }
            
            // í˜„ì¬ ë¬¸ì œ ì¸ë±ìŠ¤ ë³µì› ë° ê²€ì¦
            if (currentQuestionIndex >= testData.sentences.length) {
                currentQuestionIndex = testData.sentences.length - 1;
            }

            // ì¬ì‹œë„ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° ì²´í¬
            if (participantData.status === 'completed' && !testData.settings?.allowRetries) {
                alert('ì´ë¯¸ ì™„ë£Œëœ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.');
                window.location.href = 'result.html';
                return;
            }

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì¬ìƒ íšŸìˆ˜ ë°ì´í„° ë¡œë“œ
            loadPlayCountsFromStorage();
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        function initializeEventListeners() {
            // í…ŒìŠ¤íŠ¸ ì‹œì‘
            document.getElementById('startTestBtn').addEventListener('click', startTest);
            
            // ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸
            document.getElementById('testAudioBtn').addEventListener('click', testAudio);
            
            // ìŒì„± ì¬ìƒ
            document.getElementById('playButton').addEventListener('click', playCurrentSentence);
              // ì†ë„ ì¡°ì ˆ
            document.getElementById('speedSlowBtn').addEventListener('click', () => setSpeechRate(0.6));
            document.getElementById('speedNormalBtn').addEventListener('click', () => setSpeechRate(0.8));
            document.getElementById('speedFastBtn').addEventListener('click', () => setSpeechRate(1.0));
            
            // ë‹µì•ˆ ì œì¶œ
            document.getElementById('submitAnswerBtn').addEventListener('click', submitAnswer);
            
            // ë„¤ë¹„ê²Œì´ì…˜
            document.getElementById('nextButton').addEventListener('click', nextQuestion);
            document.getElementById('prevButton').addEventListener('click', prevQuestion);
            
            // ì™„ë£Œ í™”ë©´
            document.getElementById('viewDetailsBtn').addEventListener('click', () => {
                window.location.href = 'result.html';
            });
            
            document.getElementById('retryTestBtn').addEventListener('click', retryTest);
            
            // ì‹œê°„ ê²½ê³  ë‹«ê¸°
            document.getElementById('closeTimeWarning').addEventListener('click', () => {
                document.getElementById('timeWarningModal').style.display = 'none';
            });

            // ë‹µì•ˆ ì…ë ¥ ë³€í™” ê°ì§€ (ì œì¶œ ë²„íŠ¼ í™œì„±í™”ë§Œ)
            document.getElementById('answerInput').addEventListener('input', function(e) {
                const input = e.target.value;
                const submitBtn = document.getElementById('submitAnswerBtn');
                
                // ì…ë ¥ì´ ìˆìœ¼ë©´ ì œì¶œ ë²„íŠ¼ í™œì„±í™”
                if (input.trim()) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', handleKeyPress);

            // ìŒì„± ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° í˜¸í™˜ì„± ì²´í¬
            initializeSpeechSystem();
              // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì§„í–‰ ìƒí™© ì €ì¥ (ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ê°ì§€)
            let isUnloading = false;
            
            // 1. beforeunload ì´ë²¤íŠ¸ (ìƒˆë¡œê³ ì¹¨, ë’¤ë¡œê°€ê¸°, ì°½ ë‹«ê¸°)
            window.addEventListener('beforeunload', (e) => {
                if (testStartTime && participantData?.status === 'in-progress') {
                    isUnloading = true;
                    saveProgressSync(); // ë™ê¸°ì  ì €ì¥
                    
                    // ì‚¬ìš©ìì—ê²Œ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒì‚¬í•­)
                    e.preventDefault();
                    e.returnValue = 'í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                    return e.returnValue;
                }
            });
            
            // 2. pagehide ì´ë²¤íŠ¸ (í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ)
            window.addEventListener('pagehide', (e) => {
                if (testStartTime && participantData?.status === 'in-progress' && !isUnloading) {
                    saveProgressSync();
                }
            });
            
            // 3. unload ì´ë²¤íŠ¸ (í˜ì´ì§€ê°€ ì–¸ë¡œë“œë  ë•Œ)
            window.addEventListener('unload', (e) => {
                if (testStartTime && participantData?.status === 'in-progress') {
                    saveProgressSync();
                }
            });
            
            // 4. visibilitychange ì´ë²¤íŠ¸ (íƒ­ ì „í™˜ ë“±)
            document.addEventListener('visibilitychange', () => {
                if (testStartTime && participantData?.status === 'in-progress') {
                    if (document.hidden) {
                        // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ ì €ì¥
                        saveProgressImmediate();
                    } else {
                        // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ê²Œ ë  ë•Œ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateLastActiveTime();
                        // ì‹œê°„ ë™ê¸°í™” í™•ì¸
                        syncTimeWithServer();
                    }
                }
            });
            
            // 5. ì£¼ê¸°ì  ì €ì¥ (ë‹µì•ˆ ì œì¶œ ì‹œì—ë§Œ, 30ì´ˆë§ˆë‹¤)
            let lastSaveTime = 0;
            const saveInterval = 30000; // 30ì´ˆ
        }        // ë™ê¸°ì  ì§„í–‰ ìƒí™© ì €ì¥ (í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì‚¬ìš©)
        function saveProgressSync() {
            if (!studentSession || !testStartTime) return;
            
            try {
                const currentTime = Date.now();
                const elapsedTime = currentTime - testStartTime.getTime();
                const remainingTime = timeLimit !== null ? 
                    Math.max(0, (timeLimit * 60 * 1000) - elapsedTime) : null;

                // 1. ìš°ì„  ì„œë²„ì— ì €ì¥ ì‹œë„ (ë™ê¸°ì )
                const updateData = {
                    [`participants.${studentSession.participantId}.answers`]: answers,
                    [`participants.${studentSession.participantId}.currentQuestion`]: currentQuestionIndex,
                    [`participants.${studentSession.participantId}.elapsedTime`]: elapsedTime,
                    [`participants.${studentSession.participantId}.actualStartTime`]: testStartTime,
                    [`participants.${studentSession.participantId}.lastSaveTime`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`participants.${studentSession.participantId}.lastActiveAt`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (remainingTime !== null) {
                    updateData[`participants.${studentSession.participantId}.remainingTime`] = remainingTime;
                }
                
                // Firestoreì— ì¦‰ì‹œ ì €ì¥ (ë™ê¸°ì )
                db.collection('tests').doc(studentSession.testCode).update(updateData);
                
                // 2. localStorageì—ë„ ë°±ì—… ì €ì¥ (ì„œë²„ ì‹¤íŒ¨ ì‹œ ëŒ€ë¹„)
                const backupData = {
                    testCode: studentSession.testCode,
                    participantId: studentSession.participantId,
                    answers: answers,
                    currentQuestion: currentQuestionIndex,
                    elapsedTime: elapsedTime,
                    remainingTime: remainingTime,
                    actualStartTime: testStartTime.getTime(),
                    lastSaveTime: currentTime,
                    status: 'in-progress',
                    saveMethod: 'sync'
                };
                
                localStorage.setItem(`dictation_progress_${studentSession.testCode}_${studentSession.participantId}`, 
                    JSON.stringify(backupData));
                
                console.log('ë™ê¸°ì  ì§„í–‰ ìƒí™© ì €ì¥ ì™„ë£Œ (ì„œë²„ + ë°±ì—…)');
            } catch (error) {
                console.error('ë™ê¸°ì  ì €ì¥ ì˜¤ë¥˜:', error);
                // ì„œë²„ ì €ì¥ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë§Œì´ë¼ë„ ì €ì¥
                try {
                    const backupData = {
                        testCode: studentSession.testCode,
                        participantId: studentSession.participantId,
                        answers: answers,
                        currentQuestion: currentQuestionIndex,
                        actualStartTime: testStartTime.getTime(),
                        lastSaveTime: Date.now(),
                        status: 'in-progress',
                        saveMethod: 'emergency'
                    };
                    localStorage.setItem(`dictation_emergency_${studentSession.testCode}_${studentSession.participantId}`, 
                        JSON.stringify(backupData));
                    console.log('ê¸´ê¸‰ ë°±ì—… ì €ì¥ ì™„ë£Œ');
                } catch (emergencyError) {
                    console.error('ê¸´ê¸‰ ë°±ì—…ë„ ì‹¤íŒ¨:', emergencyError);
                }
            }
        }        // ì¦‰ì‹œ ì§„í–‰ ìƒí™© ì €ì¥ (ë¹„ë™ê¸°)
        async function saveProgressImmediate() {
            if (!studentSession || !testStartTime) return;
            
            // ìƒ˜í”Œ ëª¨ë“œì¸ ê²½ìš° ë¡œì»¬ì—ì„œë§Œ ì €ì¥
            if (studentSession.sampleMode) {
                console.log('ìƒ˜í”Œ ëª¨ë“œ - ë¡œì»¬ ì €ì¥ë§Œ ìˆ˜í–‰');
                // ë¡œì»¬ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                participantData.answers = answers;
                participantData.currentQuestion = currentQuestionIndex;
                participantData.lastSaveTime = new Date();
                return;
            }
            
            try {
                const currentTime = Date.now();
                const elapsedTime = currentTime - testStartTime.getTime();
                const remainingTime = timeLimit !== null ? 
                    Math.max(0, (timeLimit * 60 * 1000) - elapsedTime) : null;

                const updateData = {
                    [`participants.${studentSession.participantId}.answers`]: answers,
                    [`participants.${studentSession.participantId}.currentQuestion`]: currentQuestionIndex,
                    [`participants.${studentSession.participantId}.elapsedTime`]: elapsedTime,
                    [`participants.${studentSession.participantId}.lastSaveTime`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`participants.${studentSession.participantId}.lastActiveAt`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (remainingTime !== null) {
                    updateData[`participants.${studentSession.participantId}.remainingTime`] = remainingTime;
                }
                
                await db.collection('tests').doc(studentSession.testCode).update(updateData);
                console.log('ì¦‰ì‹œ ì§„í–‰ ìƒí™© ì €ì¥ ì™„ë£Œ');
                
            } catch (error) {
                console.warn('ì¦‰ì‹œ ì €ì¥ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰):', error);
            }
        }// ì„œë²„ ì‹œê°„ê³¼ ë™ê¸°í™” (ë” ì •í™•í•œ ë™ê¸°í™”)
        async function syncTimeWithServer() {
            if (!studentSession || !testStartTime) return;
            
            try {
                console.log('ì„œë²„ ì‹œê°„ ë™ê¸°í™” ì‹œì‘...');
                
                // ì„œë²„ì—ì„œ í˜„ì¬ ì°¸ì—¬ì ë°ì´í„° ì¡°íšŒ
                const testDoc = await db.collection('tests').doc(studentSession.testCode).get();
                if (!testDoc.exists) {
                    console.warn('í…ŒìŠ¤íŠ¸ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                    return;
                }
                
                const testData = testDoc.data();
                const serverParticipantData = testData.participants?.[studentSession.participantId];
                
                if (serverParticipantData) {
                    // ì„œë²„ì— ì €ì¥ëœ ì‹¤ì œ ì‹œì‘ ì‹œê°„ í™•ì¸
                    if (serverParticipantData.actualStartTime) {
                        const serverStartTime = serverParticipantData.actualStartTime.toDate();
                        const localStartTime = testStartTime;
                        const timeDiff = Math.abs(localStartTime.getTime() - serverStartTime.getTime());
                        
                        console.log('ì‹œê°„ ë™ê¸°í™” í™•ì¸:', {
                            server: serverStartTime,
                            local: localStartTime,
                            diff: `${timeDiff}ms`,
                            needsSync: timeDiff > 2000
                        });
                        
                        // 2ì´ˆ ì´ìƒ ì°¨ì´ë‚˜ë©´ ì„œë²„ ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”
                        if (timeDiff > 2000) {
                            console.log('âš ï¸ ì‹œê°„ ë¶ˆì¼ì¹˜ ê°ì§€ - ì„œë²„ ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”');
                            
                            testStartTime = serverStartTime;
                            
                            // íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì¬ì‹œì‘
                            if (testTimer && timeLimit !== null) {
                                clearInterval(testTimer);
                                startTimer();
                                console.log('íƒ€ì´ë¨¸ ì¬ì‹œì‘ë¨');
                            }
                            
                            // ì‹œê°„ ì´ˆê³¼ ì—¬ë¶€ ì¬í™•ì¸
                            if (timeLimit !== null) {
                                const elapsedTime = Date.now() - testStartTime.getTime();
                                const totalTimeMs = timeLimit * 60 * 1000;
                                const remainingTime = totalTimeMs - elapsedTime;
                                
                                if (remainingTime <= 0) {
                                    console.log('ë™ê¸°í™” í›„ ì‹œê°„ ì´ˆê³¼ ê°ì§€ - ìë™ ì œì¶œ');
                                    alert('ì œí•œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ê°€ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
                                    await submitTest(true);
                                    return;
                                }
                            }
                        }
                    }
                    
                    // ë‹µì•ˆê³¼ ì§„í–‰ ìƒí™©ë„ ì„œë²„ ê¸°ì¤€ìœ¼ë¡œ ë™ê¸°í™”
                    if (serverParticipantData.answers && Array.isArray(serverParticipantData.answers)) {
                        const serverAnswerCount = serverParticipantData.answers.length;
                        const localAnswerCount = answers.length;
                        
                        if (serverAnswerCount > localAnswerCount) {
                            console.log(`ë‹µì•ˆ ë™ê¸°í™”: ì„œë²„ ${serverAnswerCount}ê°œ > ë¡œì»¬ ${localAnswerCount}ê°œ`);
                            answers = serverParticipantData.answers;
                            currentQuestionIndex = serverParticipantData.currentQuestion || answers.length;
                            
                            // UI ì—…ë°ì´íŠ¸
                            updateProgress();
                            if (currentQuestionIndex < testData.sentences?.length) {
                                loadQuestion(currentQuestionIndex);
                            }
                        }
                    }
                }
                
                console.log('ì„œë²„ ì‹œê°„ ë™ê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì‹œê°„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
            }
        }        // í…ŒìŠ¤íŠ¸ ì‹œì‘
        async function startTest() {
            try {
                console.log('=== í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                console.log('ìƒ˜í”Œ ëª¨ë“œ:', studentSession.sampleMode);
                
                testStartTime = new Date();
                
                // ìƒ˜í”Œ ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ Firebase ì—…ë°ì´íŠ¸
                if (!studentSession.sampleMode && typeof db !== 'undefined') {
                    try {
                        const testRef = db.collection('tests').doc(studentSession.testCode);
                        await testRef.update({
                            [`participants.${studentSession.participantId}.status`]: 'in-progress',
                            [`participants.${studentSession.participantId}.startedAt`]: firebase.firestore.FieldValue.serverTimestamp(),
                            [`participants.${studentSession.participantId}.actualStartTime`]: testStartTime,
                            [`participants.${studentSession.participantId}.currentQuestion`]: 0,
                            [`participants.${studentSession.participantId}.lastActiveAt`]: firebase.firestore.FieldValue.serverTimestamp(),
                            [`participants.${studentSession.participantId}.progress`]: 0,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('Firebase ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    } catch (firebaseError) {
                        console.warn('Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', firebaseError);
                    }
                } else {
                    console.log('ìƒ˜í”Œ ëª¨ë“œ ë˜ëŠ” Firebase ì—†ìŒ - ë¡œì»¬ì—ì„œë§Œ ì§„í–‰');
                    participantData.status = 'in-progress';
                    participantData.startedAt = testStartTime;
                    participantData.actualStartTime = testStartTime;
                }

                // UI ì „í™˜
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('testScreen').classList.remove('hidden');
                
                // íƒ€ì´ë¨¸ ì‹œì‘
                startTimer();
                
                // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ heartbeat ì‹œì‘ (Firebase ì—°ê²° ì‹œë§Œ)
                if (!studentSession.sampleMode) {
                    startHeartbeat();
                }
                
                // ì²« ë²ˆì§¸ ë¬¸ì œ ë¡œë“œ
                loadQuestion(0);
                
                console.log('=== í…ŒìŠ¤íŠ¸ ì‹œì‘ ì™„ë£Œ ===');
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì‹œì‘ ì˜¤ë¥˜:', error);
                alert('í…ŒìŠ¤íŠ¸ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }// íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            // ì‹œê°„ ì œí•œì´ ì—†ìœ¼ë©´ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ì§€ ì•ŠìŒ
            if (timeLimit === null || timeLimit === undefined) {
                console.log('ì‹œê°„ ì œí•œì´ ì—†ìŠµë‹ˆë‹¤. íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì‹¤ì œ ì‹œì‘ ì‹œê°„ì´ ì—†ìœ¼ë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì • (ìƒˆë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°)
            if (!testStartTime) {
                testStartTime = new Date();
                console.log('ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì‹œì‘ ì‹œê°„ ì„¤ì •:', testStartTime);
            }
            
            const totalTime = timeLimit * 60 * 1000; // ë¶„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
            const elapsedTime = Date.now() - testStartTime.getTime(); // ì´ë¯¸ ê²½ê³¼ëœ ì‹œê°„
            const remainingTime = Math.max(0, totalTime - elapsedTime); // ë‚¨ì€ ì‹œê°„
            
            console.log(`íƒ€ì´ë¨¸ ì‹œì‘: ì „ì²´ ${timeLimit}ë¶„, ê²½ê³¼ ${Math.round(elapsedTime / 1000)}ì´ˆ, ë‚¨ì€ ${Math.round(remainingTime / 1000)}ì´ˆ`);
            
            // ì´ë¯¸ ì‹œê°„ì´ ì´ˆê³¼ëœ ê²½ìš°
            if (remainingTime <= 0) {
                console.log('ì‹œê°„ ì´ˆê³¼ - ì¦‰ì‹œ ì¢…ë£Œ');
                timeUp();
                return;
            }
            
            // ì‹œê°„ ì§„í–‰ í”„ë¡œê·¸ë˜ìŠ¤ ë°” í‘œì‹œ
            document.getElementById('timeProgressContainer').classList.remove('hidden');
              testTimer = setInterval(() => {
                const now = new Date();
                const currentElapsedTime = now.getTime() - testStartTime.getTime();
                const currentRemainingTime = Math.max(0, totalTime - currentElapsedTime);
                
                if (currentRemainingTime <= 0) {
                    // ì‹œê°„ ì¢…ë£Œ
                    clearInterval(testTimer);
                    timeUp();
                    return;
                }
                
                // ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
                const minutes = Math.floor(currentRemainingTime / 60000);
                const seconds = Math.floor((currentRemainingTime % 60000) / 1000);
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timeRemaining').textContent = timeString;
                document.getElementById('timeRemainingText').textContent = timeString;
                
                // ì‹œê°„ ì§„í–‰ í”„ë¡œê·¸ë˜ìŠ¤ ë°” ì—…ë°ì´íŠ¸
                const progressPercentage = Math.max(0, (currentRemainingTime / totalTime) * 100);
                const progressBar = document.getElementById('timeProgressBar');
                progressBar.style.width = progressPercentage + '%';
                  // ì§„í–‰ë¥ ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                if (progressPercentage > 50) {
                    progressBar.className = 'bg-gradient-to-r from-green-500 to-green-400 h-2 rounded-full transition-all duration-1000';
                } else if (progressPercentage > 25) {
                    progressBar.className = 'bg-gradient-to-r from-yellow-500 to-yellow-400 h-2 rounded-full transition-all duration-1000';
                } else {
                    progressBar.className = 'bg-gradient-to-r from-red-500 to-red-400 h-2 rounded-full transition-all duration-1000';
                }
                
                // ì‹œê°„ ê²½ê³  ì•Œë¦¼
                if (currentRemainingTime <= 5 * 60 * 1000 && currentRemainingTime > 4 * 60 * 1000 && !window.fiveMinuteWarningShown) {
                    window.fiveMinuteWarningShown = true;
                    showTimeWarning('5ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!', 'warning');
                } else if (currentRemainingTime <= 2 * 60 * 1000 && currentRemainingTime > 1 * 60 * 1000 && !window.twoMinuteWarningShown) {
                    window.twoMinuteWarningShown = true;
                    showTimeWarning('2ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!', 'danger');
                } else if (currentRemainingTime <= 30 * 1000 && currentRemainingTime > 29 * 1000 && !window.thirtySecondWarningShown) {
                    window.thirtySecondWarningShown = true;
                    showTimeWarning('30ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤!', 'critical');
                }
                
            }, 1000);
        }

        // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
        function showLoading(message = 'ë¡œë”© ì¤‘...') {
            const modal = document.getElementById('loadingModal');
            const messageElement = document.getElementById('loadingMessage');
            if (modal && messageElement) {
                messageElement.textContent = message;
                modal.style.display = 'flex';
            }
        }

        // ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ì‹œê°„ ê²½ê³  í‘œì‹œ
        function showTimeWarning(message, type = 'warning') {
            const modal = document.getElementById('timeWarningModal');
            const warningTimeElement = document.getElementById('warningTime');
            if (modal && warningTimeElement) {
                warningTimeElement.textContent = message;
                modal.style.display = 'flex';
                
                // ìë™ìœ¼ë¡œ 3ì´ˆ í›„ ë‹«ê¸°
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 3000);
            }
        }

        // ì‹œê°„ ì´ˆê³¼ ì²˜ë¦¬
        async function timeUp() {
            console.log('ì‹œê°„ ì´ˆê³¼!');
            clearInterval(testTimer);
            
            alert('ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ê°€ ìë™ìœ¼ë¡œ ì œì¶œë©ë‹ˆë‹¤.');
            await submitTest(true);
        }

        // ë¬¸ì œ ë¡œë“œ
        function loadQuestion(index) {
            if (!testData || !testData.sentences || index >= testData.sentences.length) {
                console.error('ë¬¸ì œ ë¡œë“œ ì‹¤íŒ¨: ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ë±ìŠ¤ ë˜ëŠ” ë°ì´í„°');
                return;
            }

            currentQuestionIndex = index;
            const sentence = testData.sentences[index];
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('currentQuestionNumber').textContent = index + 1;
            document.getElementById('totalQuestions').textContent = testData.sentences.length;
            
            // ì¬ìƒ íšŸìˆ˜ ì´ˆê¸°í™”
            playCount = getCurrentQuestionPlayCount();
            document.getElementById('playCount').textContent = playCount;
            
            // ë‹µì•ˆ ì…ë ¥ë€ ì´ˆê¸°í™”
            document.getElementById('answerInput').value = answers[index] || '';
              // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateNavigationButtons();
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevButton');
            const nextBtn = document.getElementById('nextButton');
            const submitBtn = document.getElementById('submitAnswerBtn');
            
            if (prevBtn) {
                prevBtn.disabled = currentQuestionIndex === 0;
            }
            
            if (nextBtn) {
                nextBtn.style.display = currentQuestionIndex >= testData.sentences.length - 1 ? 'none' : 'inline-flex';
            }
            
            if (submitBtn) {
                const input = document.getElementById('answerInput').value.trim();
                submitBtn.disabled = !input;
                if (input) {
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }        // í˜„ì¬ ë¬¸ì¥ ìŒì„± ì¬ìƒ
        function playCurrentSentence() {
            if (!testData || !testData.sentences || currentQuestionIndex >= testData.sentences.length) {
                console.error('ì¬ìƒí•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (playCount >= maxPlayCount) {
                alert(`ì´ ë¬¸ì œëŠ” ìµœëŒ€ ${maxPlayCount}ë²ˆë§Œ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }

            const sentence = testData.sentences[currentQuestionIndex];
            const text = sentence.text;

            // ìŒì„± í•©ì„±
            if ('speechSynthesis' in window) {
                // ê¸°ì¡´ ìŒì„± ì¤‘ì§€
                window.speechSynthesis.cancel();

                // ìŒì„± ëª©ë¡ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ëŒ€ì‘)
                const playWithVoice = () => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // ê¸°ë³¸ ì„¤ì •
                    utterance.lang = 'en-US';
                    utterance.rate = currentSpeechRate;
                    utterance.pitch = 1;
                    utterance.volume = 1;

                    // ì˜ì–´ ìŒì„± ì„ íƒ (ëª¨ë°”ì¼ í™˜ê²½ ê°œì„ )
                    const voices = window.speechSynthesis.getVoices();
                    let selectedVoice = null;

                    // ìš°ì„ ìˆœìœ„: ì˜ì–´ ìŒì„± ì„ íƒ
                    const englishVoices = voices.filter(voice => 
                        voice.lang.toLowerCase().startsWith('en')
                    );

                    if (englishVoices.length > 0) {
                        // ë” ë‚˜ì€ í’ˆì§ˆì˜ ì˜ì–´ ìŒì„±ì„ ìš°ì„  ì„ íƒ
                        selectedVoice = englishVoices.find(voice => {
                            const name = voice.name.toLowerCase();
                            const lang = voice.lang.toLowerCase();
                            return (
                                (lang === 'en-us' || lang === 'en-gb') &&
                                (name.includes('enhanced') || name.includes('premium') || 
                                 name.includes('neural') || name.includes('natural') || 
                                 voice.default)
                            );
                        }) || englishVoices[0]; // ì ì ˆí•œ ìŒì„±ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì˜ì–´ ìŒì„± ì‚¬ìš©
                    }

                    // ì„ íƒëœ ìŒì„± ì ìš©
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('ì„ íƒëœ ìŒì„±:', selectedVoice.name, selectedVoice.lang);
                    } else {
                        console.warn('ì˜ì–´ ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìŒì„±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    }

                    utterance.onstart = () => {
                        document.getElementById('audioStatus').textContent = 'ì¬ìƒ ì¤‘...';
                        document.getElementById('playButton').innerHTML = '<i class="fas fa-pause text-2xl"></i>';
                    };

                    utterance.onend = () => {
                        document.getElementById('audioStatus').textContent = 'ì¬ìƒ ì™„ë£Œ';
                        document.getElementById('playButton').innerHTML = '<i class="fas fa-play text-2xl"></i>';
                        
                        // ì¬ìƒ íšŸìˆ˜ ì¦ê°€
                        incrementCurrentQuestionPlayCount();
                        playCount = getCurrentQuestionPlayCount();
                        document.getElementById('playCount').textContent = playCount;
                    };

                    utterance.onerror = (event) => {
                        console.error('ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', event.error);
                        document.getElementById('audioStatus').textContent = 'ì¬ìƒ ì˜¤ë¥˜';
                        document.getElementById('playButton').innerHTML = '<i class="fas fa-play text-2xl"></i>';
                        
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë‹¤ì‹œ ì‹œë„ (ë‹¤ë¥¸ ìŒì„±ìœ¼ë¡œ)
                        if (selectedVoice) {
                            console.log('ë‹¤ë¥¸ ìŒì„±ìœ¼ë¡œ ì¬ì‹œë„...');
                            const fallbackUtterance = new SpeechSynthesisUtterance(text);
                            fallbackUtterance.lang = 'en-US';
                            fallbackUtterance.rate = currentSpeechRate;
                            window.speechSynthesis.speak(fallbackUtterance);
                        }
                    };

                    window.speechSynthesis.speak(utterance);
                    currentUtterance = utterance;
                };

                // ìŒì„± ëª©ë¡ì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ê¸°
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    // ìŒì„± ëª©ë¡ ë¡œë“œ ëŒ€ê¸°
                    window.speechSynthesis.onvoiceschanged = () => {
                        playWithVoice();
                        window.speechSynthesis.onvoiceschanged = null; // í•œ ë²ˆë§Œ ì‹¤í–‰
                    };
                } else {
                    playWithVoice();
                }
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ìŒì„± ì†ë„ ì„¤ì •
        function setSpeechRate(rate) {
            currentSpeechRate = rate;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('#speedSlowBtn, #speedNormalBtn, #speedFastBtn').forEach(btn => {
                btn.classList.remove('border-b', 'border-white/50');
                btn.classList.add('text-white/70');
            });
              if (rate === 0.6) {
                document.getElementById('speedSlowBtn').classList.add('border-b', 'border-white/50');
                document.getElementById('speedSlowBtn').classList.remove('text-white/70');
            } else if (rate === 0.8) {
                document.getElementById('speedNormalBtn').classList.add('border-b', 'border-white/50');
                document.getElementById('speedNormalBtn').classList.remove('text-white/70');
            } else if (rate === 1.0) {
                document.getElementById('speedFastBtn').classList.add('border-b', 'border-white/50');
                document.getElementById('speedFastBtn').classList.remove('text-white/70');
            }
        }        // ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸
        function testAudio() {
            if ('speechSynthesis' in window) {
                // ê¸°ì¡´ ìŒì„± ì¤‘ì§€
                window.speechSynthesis.cancel();

                const testWithVoice = () => {
                    const utterance = new SpeechSynthesisUtterance('Audio test. This is an English pronunciation test.');
                    utterance.lang = 'en-US';
                    utterance.rate = 1;
                    utterance.pitch = 1;
                    utterance.volume = 1;

                    // ì˜ì–´ ìŒì„± ì„ íƒ
                    const voices = window.speechSynthesis.getVoices();
                    const englishVoices = voices.filter(voice => 
                        voice.lang.toLowerCase().startsWith('en')
                    );

                    if (englishVoices.length > 0) {
                        const selectedVoice = englishVoices.find(voice => {
                            const name = voice.name.toLowerCase();
                            const lang = voice.lang.toLowerCase();
                            return (
                                (lang === 'en-us' || lang === 'en-gb') &&
                                (name.includes('enhanced') || name.includes('premium') || 
                                 name.includes('neural') || name.includes('natural') || 
                                 voice.default)
                            );
                        }) || englishVoices[0];

                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                            console.log('í…ŒìŠ¤íŠ¸ ìŒì„±:', selectedVoice.name, selectedVoice.lang);
                        }
                    }

                    utterance.onstart = () => {
                        console.log('ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                    };

                    utterance.onend = () => {
                        console.log('ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
                    };

                    utterance.onerror = (event) => {
                        console.error('ì˜¤ë””ì˜¤ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', event.error);
                        // í´ë°±: ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ì¬ì‹œë„
                        const fallbackUtterance = new SpeechSynthesisUtterance('Audio test');
                        fallbackUtterance.lang = 'en-US';
                        window.speechSynthesis.speak(fallbackUtterance);
                    };

                    window.speechSynthesis.speak(utterance);
                };

                // ìŒì„± ëª©ë¡ì´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë˜ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = testWithVoice;
                }
                testWithVoice();
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ë‹µì•ˆ ì œì¶œ
        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const userAnswer = answerInput.value.trim();
            
            if (!userAnswer) {
                alert('ë‹µì•ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë‹µì•ˆ ì €ì¥
            answers[currentQuestionIndex] = userAnswer;
            
            // ì„œë²„ì— ì €ì¥
            await saveProgressImmediate();
            
            // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™ ë˜ëŠ” ì™„ë£Œ
            if (currentQuestionIndex < testData.sentences.length - 1) {
                nextQuestion();
            } else {
                // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ
                await submitTest(false);
            }
        }

        // ë‹¤ìŒ ë¬¸ì œ
        function nextQuestion() {
            if (currentQuestionIndex < testData.sentences.length -  1) {
                loadQuestion(currentQuestionIndex + 1);
                updateProgress();
            }
        }

        // ì´ì „ ë¬¸ì œ
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
                updateProgress();
            }
        }        // í…ŒìŠ¤íŠ¸ ì œì¶œ
        async function submitTest(isTimeUp = false) {
            try {
                console.log('í…ŒìŠ¤íŠ¸ ì œì¶œ ì‹œì‘...');
                
                const endTime = new Date();
                const elapsedTime = testStartTime ? endTime.getTime() - testStartTime.getTime() : 0;
                const durationMinutes = Math.round(elapsedTime / 60000);
                
                // ì ìˆ˜ ê³„ì‚° ë° ìƒì„¸ ë‹µì•ˆ ìƒì„±
                let totalScore = 0;
                let correctCount = 0;
                const detailedAnswers = [];
                const results = [];
                
                for (let i = 0; i < testData.sentences.length; i++) {
                    const originalText = testData.sentences[i].text;
                    const userAnswer = answers[i] || '';
                    const scoreResult = calculateScoreDetailed(originalText, userAnswer);
                    const score = scoreResult.score;
                    const isCorrect = score >= 80; // 80ì  ì´ìƒì„ ì •ë‹µìœ¼ë¡œ ê°„ì£¼
                    
                    totalScore += score;
                    if (isCorrect) correctCount++;
                    
                    // ìƒì„¸ ë‹µì•ˆ ì •ë³´ (result.htmlì—ì„œ ì‚¬ìš©)
                    detailedAnswers.push({
                        questionIndex: i,
                        userAnswer: userAnswer,
                        isCorrect: isCorrect,
                        score: score,
                        feedback: scoreResult.feedback,
                        submittedAt: endTime,
                        playCount: playCountStorage[`q_${i}`] || 0
                    });
                    
                    // ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ results (ì˜µì…˜)
                    results.push({
                        question: i + 1,
                        original: originalText,
                        answer: userAnswer,
                        score: score,
                        isCorrect: isCorrect
                    });
                }
                
                const finalScore = Math.round(totalScore / testData.sentences.length);
                
                // ì„œë²„ì— ìµœì¢… ê²°ê³¼ ì €ì¥
                const finalData = {
                    [`participants.${studentSession.participantId}.status`]: 'completed',
                    [`participants.${studentSession.participantId}.answers`]: detailedAnswers,
                    [`participants.${studentSession.participantId}.completedAt`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`participants.${studentSession.participantId}.elapsedTime`]: elapsedTime,
                    [`participants.${studentSession.participantId}.duration`]: durationMinutes,
                    [`participants.${studentSession.participantId}.finalScore`]: finalScore,
                    [`participants.${studentSession.participantId}.correctAnswers`]: correctCount,
                    [`participants.${studentSession.participantId}.results`]: results,
                    [`participants.${studentSession.participantId}.isTimeUp`]: isTimeUp,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('ì €ì¥í•  ë°ì´í„°:', finalData);
                
                await db.collection('tests').doc(studentSession.testCode).update(finalData);
                
                console.log('í…ŒìŠ¤íŠ¸ ì œì¶œ ì™„ë£Œ');
                
                // ì™„ë£Œ í™”ë©´ í‘œì‹œ
                showCompletionScreen(finalScore, results, elapsedTime);
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì œì¶œ ì˜¤ë¥˜:', error);
                alert('í…ŒìŠ¤íŠ¸ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }        // ì ìˆ˜ ê³„ì‚° (ìƒì„¸ ì •ë³´ í¬í•¨)
        function calculateScoreDetailed(original, answer) {
            if (!answer) {
                return {
                    score: 0,
                    feedback: "ë‹µì•ˆì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                };
            }
            
            // ê¸°ì¡´ ScoringEngine ì‚¬ìš©
            if (typeof ScoringEngine !== 'undefined') {
                try {
                    const scoringEngine = new ScoringEngine({
                        caseSensitive: false,
                        strictPunctuation: false,
                        allowPartialCredit: true
                    });
                    
                    const result = scoringEngine.score(answer, original);
                    return {
                        score: Math.round(result.score || 0),
                        feedback: result.feedback || "ì±„ì  ì™„ë£Œ"
                    };
                } catch (error) {
                    console.error('ScoringEngine ì˜¤ë¥˜:', error);
                    // í´ë°±ìœ¼ë¡œ ê°„ë‹¨í•œ ì±„ì  ì‚¬ìš©
                }
            }
            
            // í´ë°±: ê°„ë‹¨í•œ ì±„ì  (ScoringEngineì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ì¸ ê²½ìš°)
            const originalWords = original.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            const answerWords = answer.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
            
            let correctWords = 0;
            for (let i = 0; i < Math.min(originalWords.length, answerWords.length); i++) {
                if (originalWords[i] === answerWords[i]) {
                    correctWords++;
                }
            }
            
            const score = Math.round((correctWords / originalWords.length) * 100);
            let feedback = "";
            
            if (score === 100) feedback = "ì™„ë²½í•©ë‹ˆë‹¤!";
            else if (score >= 80) feedback = "ì˜í–ˆì–´ìš”!";
            else if (score >= 60) feedback = "ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë³´ì„¸ìš”.";
            else feedback = "ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.";
            
            return { score, feedback };
        }
        
        // ì ìˆ˜ ê³„ì‚° (ê¸°ì¡´ í˜¸í™˜ì„±ìš©)
        function calculateScore(original, answer) {
            const result = calculateScoreDetailed(original, answer);
            return result.score;
        }

        // ì™„ë£Œ í™”ë©´ í‘œì‹œ
        function showCompletionScreen(score = 0, results = [], elapsedTime = 0) {
            // í™”ë©´ ì „í™˜
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('testScreen').classList.add('hidden');
            document.getElementById('completionScreen').classList.remove('hidden');
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('finalScore').textContent = score + '%';
            document.getElementById('correctAnswers').textContent = results.filter(r => r.score >= 80).length;
            document.getElementById('testDuration').textContent = Math.round(elapsedTime / 60000) + 'ë¶„';
            
            // íƒ€ì´ë¨¸ ì •ì§€
            if (testTimer) {
                clearInterval(testTimer);
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                // Ctrl + Enter: ë‹µì•ˆ ì œì¶œ
                const submitBtn = document.getElementById('submitAnswerBtn');
                if (submitBtn && !submitBtn.disabled) {
                    submitAnswer();
                }
            } else if (event.key === ' ' && event.ctrlKey) {
                // Ctrl + Space: ìŒì„± ì¬ìƒ
                event.preventDefault();
                playCurrentSentence();
            }
        }

        // í•˜íŠ¸ë¹„íŠ¸ (í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸)
        function startHeartbeat() {
            setInterval(async () => {
                if (testStartTime && participantData?.status === 'in-progress') {
                    await updateLastActiveTime();
                }
            }, 30000); // 30ì´ˆë§ˆë‹¤
        }

        // ë§ˆì§€ë§‰ í™œì„± ì‹œê°„ ì—…ë°ì´íŠ¸
        async function updateLastActiveTime() {
            try {
                await db.collection('tests').doc(studentSession.testCode).update({
                    [`participants.${studentSession.participantId}.lastActiveAt`]: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('í™œì„± ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // í…ŒìŠ¤íŠ¸ ì¬ì‹œë„
        function retryTest() {
            if (confirm('í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë‹µì•ˆì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                // ë°ì´í„° ì´ˆê¸°í™”
                answers = [];
                currentQuestionIndex = 0;
                testStartTime = null;
                playCountStorage = {};
                
                // UI ì´ˆê¸°í™”
                document.getElementById('completionScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
                
                // ì¬ì‹œë„ í”Œë˜ê·¸ ì„¤ì •
                participantData.status = 'pending';
                
                console.log('í…ŒìŠ¤íŠ¸ ì¬ì‹œë„ ì¤€ë¹„ ì™„ë£Œ');
            }
        }
    </script>
</body>
</html>