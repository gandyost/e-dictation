<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì •ë³´ ì…ë ¥ - English Dictation</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
      <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-100 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">
                        ğŸ“ English Dictation
                    </h1>
                </div>
                <div class="text-sm text-gray-500">
                    í•™ìƒ ì •ë³´ ì…ë ¥
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- í…ŒìŠ¤íŠ¸ ì •ë³´ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <span class="text-2xl">âœ…</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">í…ŒìŠ¤íŠ¸ ì½”ë“œ í™•ì¸ë¨</h2>
                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-600 mb-1">í…ŒìŠ¤íŠ¸ ì½”ë“œ</p>
                    <p class="text-2xl font-mono font-bold text-green-600" id="displayTestCode">-</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">í…ŒìŠ¤íŠ¸ ì œëª©</p>
                    <p class="font-semibold text-gray-900" id="displayTestTitle">-</p>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ì •ë³´ ì…ë ¥ í¼ -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-2">í•™ìƒ ì •ë³´ ì…ë ¥</h3>
                <p class="text-gray-600">í…ŒìŠ¤íŠ¸ ì°¸ì—¬ë¥¼ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            </div>
            
            <form id="studentInfoForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        í•™ë²ˆ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="studentId"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="ì˜ˆ: 20240001"
                        required
                    >
                    <p class="text-xs text-gray-500 mt-1">ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ì´ë¦„ <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="studentName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="ì˜ˆ: ê¹€í•™ìƒ"
                        required
                    >
                </div>



                <!-- ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜ -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <input 
                            type="checkbox" 
                            id="privacyConsent"
                            class="mt-1 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                            required
                        >
                        <label for="privacyConsent" class="text-sm text-gray-700">
                            <span class="font-medium">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</span>
                            <span class="text-red-500">*</span>
                            <br>
                            <span class="text-gray-500">
                                í•™ìŠµ ëª©ì ìœ¼ë¡œ í•™ë²ˆê³¼ ì´ë¦„ì´ ìˆ˜ì§‘ë˜ë©°, í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì¼ì • ê¸°ê°„ ë³´ê´€ë©ë‹ˆë‹¤.
                            </span>
                        </label>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex space-x-4">
                    <button 
                        type="button"
                        onclick="goBack()"
                        class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors"
                    >
                        ì´ì „ìœ¼ë¡œ
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                    >
                        í…ŒìŠ¤íŠ¸ ì‹œì‘
                    </button>
                </div>
            </form>
        </div>

        <!-- ë„ì›€ë§ -->
        <div class="mt-8 bg-blue-50 rounded-lg p-6">
            <h4 class="font-semibold text-gray-900 mb-2">ğŸ’¡ ë„ì›€ë§</h4>
            <ul class="text-sm text-gray-600 space-y-1">
                <li>â€¢ í•™ë²ˆê³¼ ì´ë¦„ì€ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”</li>
                <li>â€¢ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ í…ŒìŠ¤íŠ¸ë¥¼ ì´ì–´ì„œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                <li>â€¢ ë¬¸ì œê°€ ìˆì„ ê²½ìš° ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”</li>
            </ul>
        </div>
    </main>    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
            <span>í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘...</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/test-code.js"></script>
    
    <script>
        let currentTestCode = '';
        let testData = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            waitForFirebaseInit().then(() => {
                initializePage();
                setupForm();
            });
        });

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸° í•¨ìˆ˜
        function waitForFirebaseInit() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100;
                
                function checkFirebase() {
                    attempts++;
                    
                    if (window.db && window.auth) {
                        console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ í™•ì¸ë¨');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.warn('Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼, ê³„ì† ì§„í–‰');
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                }
                
                checkFirebase();
            });
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        function initializePage() {
            // URLì—ì„œ í…ŒìŠ¤íŠ¸ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            currentTestCode = urlParams.get('code') || sessionStorage.getItem('currentTestCode');
            
            if (!currentTestCode) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
                window.location.href = '../index.html';
                return;
            }

            // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const storedTestData = sessionStorage.getItem('testData');
            if (storedTestData) {
                testData = JSON.parse(storedTestData);
                displayTestInfo();
            } else {
                // í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ê²€ì¦
                validateAndDisplayTest();
            }
        }

        // í…ŒìŠ¤íŠ¸ ì •ë³´ í‘œì‹œ
        function displayTestInfo() {
            document.getElementById('displayTestCode').textContent = currentTestCode;
            document.getElementById('displayTestTitle').textContent = testData.title || 'ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸';
        }

        // í…ŒìŠ¤íŠ¸ ê²€ì¦ ë° í‘œì‹œ
        async function validateAndDisplayTest() {
            showLoading();
            try {
                const validation = await validateTestCode(currentTestCode);
                if (!validation.valid) {
                    alert(validation.message);
                    window.location.href = '../index.html';
                    return;
                }
                
                testData = validation.testData;
                sessionStorage.setItem('testData', JSON.stringify(testData));
                displayTestInfo();
                
            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ê²€ì¦ ì˜¤ë¥˜:', error);
                alert('í…ŒìŠ¤íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '../index.html';
            } finally {
                hideLoading();
            }
        }

        // í¼ ì„¤ì •
        function setupForm() {
            const form = document.getElementById('studentInfoForm');
            form.addEventListener('submit', handleFormSubmit);

            // í•™ë²ˆ ì…ë ¥ ì‹œ ìˆ«ìë§Œ í—ˆìš©
            document.getElementById('studentId').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const privacyConsent = document.getElementById('privacyConsent').checked;

            // ìœ íš¨ì„± ê²€ì‚¬
            if (!studentId || !studentName) {
                alert('í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!privacyConsent) {
                alert('ê°œì¸ì •ë³´ ì²˜ë¦¬ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            showLoading();

            try {
                // í•™ìƒ ì •ë³´ ì €ì¥
                const studentInfo = {
                    studentId: studentId,
                    name: studentName,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // í…ŒìŠ¤íŠ¸ ì°¸ì—¬ì ëª©ë¡ì— ì¶”ê°€
                await updateParticipants(studentInfo);

                // í•™ìƒ ì„¸ì…˜ ì •ë³´ ìƒì„± (ì¸ì¦ëœ ì„¸ì…˜)
                const sessionInfo = {
                    testCode: currentTestCode,
                    participantId: studentInfo.studentId,
                    participantName: studentInfo.name,
                    sessionId: generateSessionId(),
                    authenticatedAt: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24ì‹œê°„ í›„ ë§Œë£Œ
                };

                // ì„¸ì…˜ ì •ë³´ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                sessionStorage.setItem('studentSession', JSON.stringify(sessionInfo));
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));

                console.log('í•™ìƒ ì •ë³´ ì €ì¥ ì„±ê³µ');
                
                // ë°›ì•„ì“°ê¸° í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™ (ì„¸ì…˜ ì •ë³´ë§Œìœ¼ë¡œ ì ‘ê·¼)
                window.location.href = 'dictation.html';

            } catch (error) {
                console.error('í•™ìƒ ì •ë³´ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                hideLoading();
            }
        }        // ì°¸ì—¬ì ëª©ë¡ ì—…ë°ì´íŠ¸
        async function updateParticipants(studentInfo) {
            try {
                // Firebase ë°ì´í„°ë² ì´ìŠ¤ ì°¸ì¡° í™•ì¸
                if (!window.db) {
                    throw new Error('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
                const testRef = window.db.collection('tests').doc(currentTestCode);
                  // íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì°¸ì—¬ì ì¶”ê°€
                await window.db.runTransaction(async (transaction) => {
                    const testDoc = await transaction.get(testRef);
                    
                    if (!testDoc.exists) {
                        throw new Error('í…ŒìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                      const currentTestData = testDoc.data();
                    const participants = currentTestData.participants || {};
                    
                    // ì´ë¯¸ ì°¸ì—¬í•œ í•™ìƒì¸ì§€ í™•ì¸
                    if (participants[studentInfo.studentId]) {
                        const existingParticipant = participants[studentInfo.studentId];
                        
                        // ì´ë¯¸ ì™„ë£Œí•œ í…ŒìŠ¤íŠ¸ì¸ì§€ í™•ì¸
                        if (existingParticipant.status === 'completed') {
                            // ì¬ì‹œë„ í—ˆìš© ì—¬ë¶€ í™•ì¸
                            if (!currentTestData.settings?.allowRetries) {
                                throw new Error(`ì´ë¯¸ ì™„ë£Œí•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.\ní•™ë²ˆ: ${studentInfo.studentId}\nì´ë¦„: ${existingParticipant.name}\n\nì¬ì‹œë„ê°€ í—ˆìš©ë˜ì§€ ì•ŠëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.`);
                            } else {
                                // ì¬ì‹œë„ í—ˆìš©ì¸ ê²½ìš° í™•ì¸ ë©”ì‹œì§€
                                const confirmRetry = confirm(`ì´ë¯¸ ì™„ë£Œí•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.\ní•™ë²ˆ: ${studentInfo.studentId}\nì´ë¦„: ${existingParticipant.name}\n\në‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ì „ ê²°ê³¼ëŠ” ì‚­ì œë©ë‹ˆë‹¤)`);
                                if (!confirmRetry) {
                                    throw new Error('í…ŒìŠ¤íŠ¸ ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        } else if (existingParticipant.status === 'in-progress') {
                            // ì§„í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°
                            const confirmContinue = confirm(`ì§„í–‰ ì¤‘ì¸ í…ŒìŠ¤íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.\ní•™ë²ˆ: ${studentInfo.studentId}\nì´ë¦„: ${existingParticipant.name}\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                            if (!confirmContinue) {
                                throw new Error('í…ŒìŠ¤íŠ¸ ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                        
                        // ì´ë¦„ì´ ë‹¤ë¥¸ ê²½ìš° í™•ì¸
                        if (existingParticipant.name !== studentInfo.name) {
                            const confirmName = confirm(`ë“±ë¡ëœ ì´ë¦„ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.\në“±ë¡ëœ ì´ë¦„: ${existingParticipant.name}\nì…ë ¥í•œ ì´ë¦„: ${studentInfo.name}\n\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                            if (!confirmName) {
                                throw new Error('ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            }
                        }
                        
                        console.log('ê¸°ì¡´ ì°¸ì—¬ì ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.');
                    }
                    
                    // ì°¸ì—¬ì ì •ë³´ ì¶”ê°€/ì—…ë°ì´íŠ¸
                    const participantData = {
                        studentId: studentInfo.studentId,
                        name: studentInfo.name,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: participants[studentInfo.studentId]?.status === 'in-progress' ? 'in-progress' : 'joined',
                        currentSentence: participants[studentInfo.studentId]?.currentSentence || 0,
                        totalScore: participants[studentInfo.studentId]?.totalScore || 0,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                      // ì¬ì‹œë„ì¸ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
                    if (participants[studentInfo.studentId]?.status === 'completed' && currentTestData.settings?.allowRetries) {
                        participantData.status = 'joined';
                        participantData.currentSentence = 0;
                        participantData.totalScore = 0;
                        participantData.answers = [];
                        participantData.finalScore = null;
                        participantData.correctAnswers = null;
                        participantData.completedAt = null;
                        participantData.duration = null;
                    }
                    
                    participants[studentInfo.studentId] = participantData;
                    
                    // ë¬¸ì„œ ì—…ë°ì´íŠ¸
                    transaction.update(testRef, {
                        participants: participants,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                console.log('ì°¸ì—¬ì ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ì°¸ì—¬ì ì •ë³´ ì €ì¥ ì˜¤ë¥˜:', error);
                
                // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° ë” ìì„¸í•œ ì •ë³´ ì œê³µ
                if (error.code === 'permission-denied') {
                    throw new Error('í…ŒìŠ¤íŠ¸ ì°¸ì—¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else if (error.code === 'not-found') {
                    throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.');
                } else if (error.message.includes('ì´ë¯¸ ì™„ë£Œí•œ í…ŒìŠ¤íŠ¸') || 
                          error.message.includes('í…ŒìŠ¤íŠ¸ ì°¸ì—¬ê°€ ì·¨ì†Œ') || 
                          error.message.includes('ì´ë¦„ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤')) {
                    throw error; // ì‚¬ìš©ì ì •ì˜ ì˜¤ë¥˜ ê·¸ëŒ€ë¡œ ì „ë‹¬
                } else {
                    throw new Error('ì°¸ì—¬ì ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }

        // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
        function goBack() {
            window.history.back();
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('loadingSpinner').classList.remove('flex');
        }

        // ì„¸ì…˜ ID ìƒì„± í•¨ìˆ˜
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }    </script>    <!-- JavaScript íŒŒì¼ë“¤ -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/student.js?v=2"></script>
</body>
</html>
