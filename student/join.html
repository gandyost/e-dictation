<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 정보 입력 - English Dictation</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
      <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-100 min-h-screen">
    <!-- 헤더 -->
    <header class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">
                        📝 English Dictation
                    </h1>
                </div>
                <div class="text-sm text-gray-500">
                    학생 정보 입력
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- 테스트 정보 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                    <span class="text-2xl">✅</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">테스트 코드 확인됨</h2>
                <div class="bg-gray-100 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-600 mb-1">테스트 코드</p>
                    <p class="text-2xl font-mono font-bold text-green-600" id="displayTestCode">-</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">테스트 제목</p>
                    <p class="font-semibold text-gray-900" id="displayTestTitle">-</p>
                </div>
            </div>
        </div>

        <!-- 학생 정보 입력 폼 -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-2">학생 정보 입력</h3>
                <p class="text-gray-600">테스트 참여를 위해 정보를 입력해주세요</p>
            </div>
            
            <form id="studentInfoForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        학번 <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="studentId"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="예: 20240001"
                        required
                    >
                    <p class="text-xs text-gray-500 mt-1">숫자만 입력해주세요</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        이름 <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="studentName"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        placeholder="예: 김학생"
                        required
                    >
                </div>



                <!-- 개인정보 처리 동의 -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <input 
                            type="checkbox" 
                            id="privacyConsent"
                            class="mt-1 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                            required
                        >
                        <label for="privacyConsent" class="text-sm text-gray-700">
                            <span class="font-medium">개인정보 수집·이용 동의</span>
                            <span class="text-red-500">*</span>
                            <br>
                            <span class="text-gray-500">
                                학습 목적으로 학번과 이름이 수집되며, 테스트 완료 후 일정 기간 보관됩니다.
                            </span>
                        </label>
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="flex space-x-4">
                    <button 
                        type="button"
                        onclick="goBack()"
                        class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-gray-600 transition-colors"
                    >
                        이전으로
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition-colors"
                    >
                        테스트 시작
                    </button>
                </div>
            </form>
        </div>

        <!-- 도움말 -->
        <div class="mt-8 bg-blue-50 rounded-lg p-6">
            <h4 class="font-semibold text-gray-900 mb-2">💡 도움말</h4>
            <ul class="text-sm text-gray-600 space-y-1">
                <li>• 학번과 이름은 정확히 입력해주세요</li>
                <li>• 브라우저를 닫아도 테스트를 이어서 할 수 있습니다</li>
                <li>• 문제가 있을 경우 선생님께 문의하세요</li>
            </ul>
        </div>
    </main>    <!-- 로딩 스피너 -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
            <span>테스트 준비 중...</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/test-code.js"></script>
    
    <script>
        let currentTestCode = '';
        let testData = null;
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase 초기화 대기
            waitForFirebaseInit().then(() => {
                initializePage();
                setupForm();
            });
        });

        // Firebase 초기화 대기 함수
        function waitForFirebaseInit() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100;
                
                function checkFirebase() {
                    attempts++;
                    
                    if (window.db && window.auth) {
                        console.log('Firebase 초기화 완료 확인됨');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.warn('Firebase 초기화 대기 시간 초과, 계속 진행');
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                }
                
                checkFirebase();
            });
        }

        // 페이지 초기화
        function initializePage() {
            // URL에서 테스트 코드 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            currentTestCode = urlParams.get('code') || sessionStorage.getItem('currentTestCode');
            
            if (!currentTestCode) {
                alert('잘못된 접근입니다.');
                window.location.href = '../index.html';
                return;
            }

            // 세션 스토리지에서 테스트 데이터 가져오기
            const storedTestData = sessionStorage.getItem('testData');
            if (storedTestData) {
                testData = JSON.parse(storedTestData);
                displayTestInfo();
            } else {
                // 테스트 데이터가 없으면 다시 검증
                validateAndDisplayTest();
            }
        }

        // 테스트 정보 표시
        function displayTestInfo() {
            document.getElementById('displayTestCode').textContent = currentTestCode;
            document.getElementById('displayTestTitle').textContent = testData.title || '받아쓰기 테스트';
        }

        // 테스트 검증 및 표시
        async function validateAndDisplayTest() {
            showLoading();
            try {
                const validation = await validateTestCode(currentTestCode);
                if (!validation.valid) {
                    alert(validation.message);
                    window.location.href = '../index.html';
                    return;
                }
                
                testData = validation.testData;
                sessionStorage.setItem('testData', JSON.stringify(testData));
                displayTestInfo();
                
            } catch (error) {
                console.error('테스트 검증 오류:', error);
                alert('테스트 정보를 가져오는 중 오류가 발생했습니다.');
                window.location.href = '../index.html';
            } finally {
                hideLoading();
            }
        }

        // 폼 설정
        function setupForm() {
            const form = document.getElementById('studentInfoForm');
            form.addEventListener('submit', handleFormSubmit);

            // 학번 입력 시 숫자만 허용
            document.getElementById('studentId').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
        }

        // 폼 제출 처리
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const privacyConsent = document.getElementById('privacyConsent').checked;

            // 유효성 검사
            if (!studentId || !studentName) {
                alert('학번과 이름을 입력해주세요.');
                return;
            }

            if (!privacyConsent) {
                alert('개인정보 처리 동의가 필요합니다.');
                return;
            }

            showLoading();

            try {
                // 학생 정보 저장
                const studentInfo = {
                    studentId: studentId,
                    name: studentName,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // 테스트 참여자 목록에 추가
                await updateParticipants(studentInfo);

                // 학생 세션 정보 생성 (인증된 세션)
                const sessionInfo = {
                    testCode: currentTestCode,
                    participantId: studentInfo.studentId,
                    participantName: studentInfo.name,
                    sessionId: generateSessionId(),
                    authenticatedAt: Date.now(),
                    expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24시간 후 만료
                };

                // 세션 정보를 세션 스토리지에 저장
                sessionStorage.setItem('studentSession', JSON.stringify(sessionInfo));
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));

                console.log('학생 정보 저장 성공');
                
                // 받아쓰기 테스트 페이지로 이동 (세션 정보만으로 접근)
                window.location.href = 'dictation.html';

            } catch (error) {
                console.error('학생 정보 저장 오류:', error);
                alert('정보 저장 중 오류가 발생했습니다. 다시 시도해주세요.');
            } finally {
                hideLoading();
            }
        }        // 참여자 목록 업데이트
        async function updateParticipants(studentInfo) {
            try {
                // Firebase 데이터베이스 참조 확인
                if (!window.db) {
                    throw new Error('데이터베이스 연결이 초기화되지 않았습니다.');
                }
                
                const testRef = window.db.collection('tests').doc(currentTestCode);
                  // 트랜잭션을 사용하여 안전하게 참여자 추가
                await window.db.runTransaction(async (transaction) => {
                    const testDoc = await transaction.get(testRef);
                    
                    if (!testDoc.exists) {
                        throw new Error('테스트를 찾을 수 없습니다.');
                    }
                      const currentTestData = testDoc.data();
                    const participants = currentTestData.participants || {};
                    
                    // 이미 참여한 학생인지 확인
                    if (participants[studentInfo.studentId]) {
                        const existingParticipant = participants[studentInfo.studentId];
                        
                        // 이미 완료한 테스트인지 확인
                        if (existingParticipant.status === 'completed') {
                            // 재시도 허용 여부 확인
                            if (!currentTestData.settings?.allowRetries) {
                                throw new Error(`이미 완료한 테스트입니다.\n학번: ${studentInfo.studentId}\n이름: ${existingParticipant.name}\n\n재시도가 허용되지 않는 테스트입니다.`);
                            } else {
                                // 재시도 허용인 경우 확인 메시지
                                const confirmRetry = confirm(`이미 완료한 테스트입니다.\n학번: ${studentInfo.studentId}\n이름: ${existingParticipant.name}\n\n다시 시도하시겠습니까? (이전 결과는 삭제됩니다)`);
                                if (!confirmRetry) {
                                    throw new Error('테스트 참여가 취소되었습니다.');
                                }
                            }
                        } else if (existingParticipant.status === 'in-progress') {
                            // 진행 중인 테스트가 있는 경우
                            const confirmContinue = confirm(`진행 중인 테스트가 있습니다.\n학번: ${studentInfo.studentId}\n이름: ${existingParticipant.name}\n\n계속 진행하시겠습니까?`);
                            if (!confirmContinue) {
                                throw new Error('테스트 참여가 취소되었습니다.');
                            }
                        }
                        
                        // 이름이 다른 경우 확인
                        if (existingParticipant.name !== studentInfo.name) {
                            const confirmName = confirm(`등록된 이름과 다릅니다.\n등록된 이름: ${existingParticipant.name}\n입력한 이름: ${studentInfo.name}\n\n계속 진행하시겠습니까?`);
                            if (!confirmName) {
                                throw new Error('이름이 일치하지 않습니다.');
                            }
                        }
                        
                        console.log('기존 참여자 정보를 업데이트합니다.');
                    }
                    
                    // 참여자 정보 추가/업데이트
                    const participantData = {
                        studentId: studentInfo.studentId,
                        name: studentInfo.name,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: participants[studentInfo.studentId]?.status === 'in-progress' ? 'in-progress' : 'joined',
                        currentSentence: participants[studentInfo.studentId]?.currentSentence || 0,
                        totalScore: participants[studentInfo.studentId]?.totalScore || 0,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };
                      // 재시도인 경우 기존 데이터 초기화
                    if (participants[studentInfo.studentId]?.status === 'completed' && currentTestData.settings?.allowRetries) {
                        participantData.status = 'joined';
                        participantData.currentSentence = 0;
                        participantData.totalScore = 0;
                        participantData.answers = [];
                        participantData.finalScore = null;
                        participantData.correctAnswers = null;
                        participantData.completedAt = null;
                        participantData.duration = null;
                    }
                    
                    participants[studentInfo.studentId] = participantData;
                    
                    // 문서 업데이트
                    transaction.update(testRef, {
                        participants: participants,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                console.log('참여자 정보가 성공적으로 저장되었습니다.');
                
            } catch (error) {
                console.error('참여자 정보 저장 오류:', error);
                
                // 권한 오류인 경우 더 자세한 정보 제공
                if (error.code === 'permission-denied') {
                    throw new Error('테스트 참여 권한이 없습니다. 테스트 코드를 확인해주세요.');
                } else if (error.code === 'not-found') {
                    throw new Error('존재하지 않는 테스트입니다.');
                } else if (error.message.includes('이미 완료한 테스트') || 
                          error.message.includes('테스트 참여가 취소') || 
                          error.message.includes('이름이 일치하지 않습니다')) {
                    throw error; // 사용자 정의 오류 그대로 전달
                } else {
                    throw new Error('참여자 정보 저장 중 오류가 발생했습니다.');
                }
            }
        }

        // 이전 페이지로 이동
        function goBack() {
            window.history.back();
        }

        // 로딩 표시/숨김
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('loadingSpinner').classList.remove('flex');
        }

        // 세션 ID 생성 함수
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }    </script>    <!-- JavaScript 파일들 -->
    <script src="../js/firebase-config.js?v=4"></script>
    <script src="../js/student.js?v=2"></script>
</body>
</html>
